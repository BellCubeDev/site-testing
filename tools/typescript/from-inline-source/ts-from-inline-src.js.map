{"version":3,"file":"ts-from-inline-src.ts","names":["hljs","typescript","parseFromJSON","obj","JSON","parse","Error","console","debug","sources","i","length","file","contents","sourcesContent","trim","replace","setOutput","async","outs_","prefabOutput","document","getElementById","outputArea","outs","Object","entries","style","opacity","Promise","resolve","addEventListener","once","setTimeout","removeEventListener","innerHTML","data","output","cloneNode","id","classList","remove","removeAttribute","querySelector","textContent","highlight","language","value","appendChild","registerLanguage","window","bcd_init_functions","tsFromInline","fromInline","ui","dataUpdated","evt","elem","target","str","match","undefined","uri","URL","protocol","ext","pathname","error","atob","parseFromURL","err","TypeError","parseData","info"],"sourceRoot":"https://raw.githubusercontent.com/BellCubeDev/site-testing/deployment/","sources":["https://raw.githubusercontent.com/BellCubeDev/site-testing/deployment/tools/typescript/from-inline-source/ts-from-inline-src.ts"],"sourcesContent":["import hljs from '../../../assets/site/highlight_js/highlight.js';\n\n// HLJS Language Definition\nimport typescript from '../../../assets/site/highlight_js/languages/typescript.js';\nimport { registerForEvents } from '../../../universal.js';\nhljs.registerLanguage('typescript', typescript);\n\ndeclare global {interface Window {\n    fromInline: {\n        ui: {\n            dataUpdated: (evt:Event) => void\n        }\n    }\n}}\n\nwindow.bcd_init_functions.tsFromInline = function tsFromInline(){\n    window.fromInline = {} as any;\n    window.fromInline.ui = {\n        dataUpdated(evt:Event) {\n            console.debug('Data updated:', evt);\n            if (!evt) throw new Error('There must be no hero, for there is no event.');\n            const elem = (evt.target as HTMLTextAreaElement|undefined);\n            if (!elem) throw new Error('no target');\n\n            try {\n                parseData(elem.value.trim());\n            } catch (err) {\n                console.info('Parser failed with error', err);\n                setOutput({});\n            }\n        }\n    };\n};\n\n\nfunction parseData(str: string){\n\n    // Extract data url from the full file or, barring that, use the input as-is\n    [,str] = str.match(/^\\/\\/# sourceMappingURL=(.*)/mi) ?? [undefined, str];\n\n    console.debug('Parsing data:', str);\n\n    try {\n        const urlFrom = new URL(str);\n        parseFromURL(urlFrom);\n    }\n\n    catch (err) {\n        if (!(err instanceof TypeError)) throw err;\n        console.debug('Input is not a URL', str, '\\n', err);\n\n        parseFromJSON(str);\n    }\n}\n\n/** Parses an `application/json` Data URI into its raw JSON component and passes it on to ParseJSON */\nasync function parseFromURL(uri: URL){\n    if (typeof uri === 'string') uri = new URL(uri);\n    else if (!(uri instanceof URL)) throw new Error('Input is not a valid URI');\n\n    if (uri.protocol !== 'data:') throw new Error('Only `data:` URIs are supported');\n\n    const [,ext, data] = uri.pathname.trim().match(/^(.+?);(?:[^,]*?;)*base64,(.*)$/) ?? [];\n\n    if (ext !== 'application/json' || !data) {\n        console.error(uri);\n        throw new Error('Invalid Data URI or incorrect MIME type - see the above output for the URI');\n    }\n\n    const str = atob(data);\n    //const str = decodeURIComponent(escape(window.atob(data)));\n    //const str = (await new Blob([data], {type: 'ext', endings: 'native'}).text()).toString();\n\n    parseFromJSON(str);\n}\n\ntype outs = {[file:string]: string}\n\nfunction parseFromJSON(obj: any) {\n    if (typeof obj === 'string') obj = JSON.parse(obj);\n    else if (typeof obj !== 'object') throw new Error('Input is not a JSON object');\n\n    console.debug('Working with object:\\n', obj);\n\n    const sources:outs = {};\n\n    for (let i = 0; i < obj.sources.length; i++) {\n        const file = obj.sources[i];\n\n        // eslint-disable-next-line prefer-template\n        const contents = (obj.sourcesContent[i] as string).trim().replace(/[^\\n\\S]+(?:\\r\\n?|\\n)/g, '\\n') + '\\n';\n\n        console.debug('Source', i, {[`${file}`]: contents});\n        sources[file] = contents;\n    }\n\n    setOutput(sources);\n}\n\nasync function setOutput(outs_: outs) {\n    const prefabOutput = document.getElementById('prefab-output') as HTMLDivElement;\n    const outputArea = document.getElementById('output-area') as HTMLDivElement;\n    const outs = Object.entries(outs_);\n\n    // NOTE: REQUIRES an opacity transition under 200ms!\n\n    outputArea.style.opacity = '0';\n\n    // Wait for the transition to finish\n    await new Promise(resolve => {\n        outputArea.addEventListener('transitionend', resolve, {once: true});\n        setTimeout(() => {\n            outputArea.removeEventListener('transitionend', resolve);\n            resolve('timeout');\n        }, 200);\n    });\n\n    outputArea.innerHTML = '';\n    outputArea.style.opacity = '1'; // Don't worry, this isn't a race condition - thank you, Event Loop!\n\n    for (let i = 0; i < outs.length; i++) {\n        const [file, data] = outs[i]!;\n\n        const output = prefabOutput.cloneNode(true) as HTMLDivElement;\n        output.id = `output-${i}`;\n        output.classList.remove('hidden');\n        output.removeAttribute('aria-hidden');\n\n        output.querySelector('h3')!.textContent = file.trim();\n\n        const code = output.querySelector('pre > code')!;\n        code.innerHTML = hljs.highlight(data.trim(), {language: 'typescript'}).value.replace(/^\\s*/y, '');\n\n        outputArea.appendChild(output);\n    }\n\n}\n"],"mappings":"OAAOA,OAAU,wDAGVC,OAAgB,4DA2EvB,SAASC,GAAcC,GACnB,GAAmB,iBAARA,EAAkBA,EAAMC,KAAKC,MAAMF,QACzC,GAAmB,iBAARA,EAAkB,MAAM,IAAIG,MAAM,8BAElDC,QAAQC,MAAM,yBAA0BL,GAExC,MAAMM,EAAe,GAErB,IAAK,IAAIC,EAAI,EAAGA,EAAIP,EAAIM,QAAQE,OAAQD,IAAK,CACzC,MAAME,EAAOT,EAAIM,QAAQC,GAGnBG,EAAYV,EAAIW,eAAeJ,GAAcK,OAAOC,QAAQ,wBAAyB,MAAQ,KAEnGT,QAAQC,MAAM,SAAUE,EAAG,CAAC,CAAC,GAAGE,KAASC,IACzCJ,EAAQG,GAAQC,C,CAGpBI,GAAUR,EACd,CAEAS,eAAeD,GAAUE,GACrB,MAAMC,EAAeC,SAASC,eAAe,iBACvCC,EAAaF,SAASC,eAAe,eACrCE,EAAOC,OAAOC,QAAQP,GAI5BI,EAAWI,MAAMC,QAAU,UAGrB,IAAIC,QAAQC,IACdP,EAAWQ,iBAAiB,gBAAiBD,EAAS,CAACE,MAAM,IAC7DC,WAAW,KACPV,EAAWW,oBAAoB,gBAAiBJ,GAChDA,EAAQ,UAAU,EACnB,IAAI,GAGXP,EAAWY,UAAY,GACvBZ,EAAWI,MAAMC,QAAU,IAE3B,IAAK,IAAIlB,EAAI,EAAGA,EAAIc,EAAKb,OAAQD,IAAK,CAClC,MAAOE,EAAMwB,GAAQZ,EAAKd,GAEpB2B,EAASjB,EAAakB,WAAU,GACtCD,EAAOE,GAAK,UAAU7B,IACtB2B,EAAOG,UAAUC,OAAO,UACxBJ,EAAOK,gBAAgB,eAEvBL,EAAOM,cAAc,MAAOC,YAAchC,EAAKG,OAElCsB,EAAOM,cAAc,cAC7BR,UAAYnC,GAAK6C,UAAUT,EAAKrB,OAAQ,CAAC+B,SAAU,eAAeC,MAAM/B,QAAQ,QAAS,IAE9FO,EAAWyB,YAAYX,E,CAG/B,CAnIArC,GAAKiD,iBAAiB,aAAchD,IAUpCiD,OAAOC,mBAAmBC,aAAe,WACrCF,OAAOG,WAAa,GACpBH,OAAOG,WAAWC,GAAK,CACnBC,YAAYC,GAER,GADAjD,QAAQC,MAAM,gBAAiBgD,IAC1BA,EAAK,MAAM,IAAIlD,MAAM,iDAC1B,MAAMmD,EAAQD,EAAIE,OAClB,IAAKD,EAAM,MAAM,IAAInD,MAAM,aAE3B,KAWZ,SAAmBqD,IAGd,CAACA,GAAOA,EAAIC,MAAM,mCAAqC,MAACC,EAAWF,GAEpEpD,QAAQC,MAAM,gBAAiBmD,GAE/B,KAcJzC,eAA4B4C,GACxB,GAAmB,iBAARA,EAAkBA,EAAM,IAAIC,IAAID,QACtC,KAAMA,aAAeC,KAAM,MAAM,IAAIzD,MAAM,4BAEhD,GAAqB,UAAjBwD,EAAIE,SAAsB,MAAM,IAAI1D,MAAM,mCAE9C,MAAO,CAAC2D,EAAK7B,GAAQ0B,EAAII,SAASnD,OAAO6C,MAAM,oCAAsC,GAErF,GAAY,qBAARK,IAA+B7B,EAE/B,MADA7B,QAAQ4D,MAAML,GACR,IAAIxD,MAAM,8EAOpBJ,GAJYkE,KAAKhC,GAKrB,CA9BQiC,CADgB,IAAIN,IAAIJ,G,CAI5B,MAAOW,GACH,KAAMA,aAAeC,WAAY,MAAMD,EACvC/D,QAAQC,MAAM,qBAAsBmD,EAAK,KAAMW,GAE/CpE,GAAcyD,E,CAEtB,CA5BgBa,CAAUf,EAAKV,MAAMhC,O,CACvB,MAAOuD,GACL/D,QAAQkE,KAAK,2BAA4BH,GACzCrD,GAAU,G,CAElB,EAER"}