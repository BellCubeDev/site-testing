import*as I from"./fomod-builder-classifications.js";import*as O from"./fomod-builder-ui.js";import{anAnimationFrame as D,registerUpgrade as F,BCDDropdown as M,registerForEvents as v,unregisterForEvents as T,UpdatableObject as B,BCDSummary as N}from"../../universal.js";import{updatePluralDisplay as G}from"./fomod-builder-ui.js";import{componentHandler as j}from"../../assets/site/mdl/material.js";import z from"../../included_node_modules/sortablejs/modular/sortable.esm.js";const R=z;export const sortableSettings={ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",selectedClass:"sortable-selected",dragClass:"sortable-drag",fallbackClass:"sortable-fallback",handle:".builder-steps-drag-handle",dataIdAttr:"data-id",animation:250,bubbleScroll:!0,scroll:document.body.querySelector("main"),scrollSensitivity:128,scrollSpeed:64,delay:200,delayOnTouchOnly:!0,direction:"vertical",sort:!0,multiDrag:!0};export const sortableSettings_steps={...sortableSettings,group:"steps",draggable:".builder-steps-step"};export const sortableSettings_groups={...sortableSettings,group:"groups",draggable:".builder-steps-group"};export const sortableSettings_options={...sortableSettings,group:"options",draggable:".builder-steps-option"};export const sortableSettings_flags={...sortableSettings,group:"flags",draggable:".builder-steps-option-flag"};class L extends B{main;deleteButton;dragHandle;sortable;async updateCard(){return await Promise.all([this.updateDeleteButton(),this.updateSortingHandler()])}update_(){this.updateCard()}minimumItemsToSort=2;minimumChildrenToSort=2;async updateDeleteButton(t){this.deleteButton&&(await D(),this.parentGroup?.size&&this.parentGroup.size>=this.minimumItemsToSort?(this.deleteButton.style.opacity="1",this.deleteButton.ariaDisabled="false",this.deleteButton.disabled=!1,this.deleteButton.setAttribute("data-force-disabled","false"),this.deleteButton.style.pointerEvents="auto",this.deleteButton.setAttribute("data-force-pointer-events","true"),this.deleteButton.tabIndex=0,this.deleteButton.setAttribute("data-old-tabindex","0")):(this.deleteButton.style.opacity="0.1",this.deleteButton.ariaDisabled="true",this.deleteButton.disabled=!0,this.deleteButton.setAttribute("data-force-disabled","true"),this.deleteButton.style.pointerEvents="none",this.deleteButton.setAttribute("data-force-pointer-events","false"),this.deleteButton.tabIndex=-1,this.deleteButton.setAttribute("data-old-tabindex","-1")))}async updateSortingHandler(){this.sortable&&(await D(),(this.children?.size||0)>=this.minimumChildrenToSort?(this.sortable?.option("ignore",void 0),this.childrenContainer?.classList.remove("no-sorting")):(this.sortable?.option("ignore","*"),this.childrenContainer?.classList.add("no-sorting")))}onSort(t,e=!1){if(!this.childClass)return;if(t.from!==t.to&&!e)return console.debug("Not sorting",this,t);if(void 0===t.newIndex||!e&&t.newIndex===t.oldIndex)return console.debug("No index change",this,t);const n=t.item.upgrades?.get(this.childClass);if(!n)return console.error("Child Class instance not found!",this,t);this.children?.moveIndex(n.parent,t.newIndex),this.parent?.update()}onSort_bound=this.onSort.bind(this);onAdd(t){if(!this.childClass)return;if(t.from===t.to||t.to!==this.childrenContainer)return console.debug("Not adding",this,t);const e=t.item.upgrades?.get(this.childClass);if(!e)return console.error("The FOMOD Builder binding for this item was not found!",this,t);e.parent.inherited&&(e.parent.inherited.parent=this.parent),this.children?.add(e.parent),this.onSort(t,!0),this.parent?.updateWhole()}onAdd_bound=this.onAdd.bind(this);onRemove(t){if(!this.childClass)return;if(t.from===t.to||t.from!==this.childrenContainer)return console.debug("Not removing",this,t);const e=t.item.upgrades?.get(this.childClass);if(!e)return console.error("The FOMOD Builder binding for this item was not found!",this,t);this.children?.delete(e.parent),this.parent?.updateWhole()}onRemove_bound=this.onRemove.bind(this);async destroy_(){const t=this.main,e=this.main.previousSibling?.style;e&&(e.zIndex="1");const n=this.main.querySelector(":scope > .js-bcd-summary")?.upgrades?.get(N);if(n&&await n.close(!1,!1,!0,500),t.classList.add("animating-out"),"none"===getComputedStyle(t).animationName)return this.main.remove();t.addEventListener("animationend",function(){e&&(e.zIndex=""),t.remove()},{once:!0})}animateIn(t){if("none"===this.main.style.animationName)return;const e=t.lastElementChild instanceof HTMLElement?t.lastElementChild:void 0;if(!e)return;const n=this.main;e.style.zIndex="1",n.classList.add("animating-in");const i=function(){e.style.zIndex="",n.classList.remove("animating-in"),n.removeEventListener("animationend",i)};n.addEventListener("animationend",i,{once:!0})}}const U=document.getElementById("builder-main-steps-delete-button").content.firstElementChild,H=document.getElementById("builder-main-steps-drag-handle").content.firstElementChild;export class Fomod extends L{parent;parentGroup;get childClass(){return Step}get children(){return this.parent.steps}get childrenContainer(){return this.parent.stepContainers["1st-party"]}nameInput;get name(){return this.parent.moduleName}set name(t){this.parent.moduleName=t}imageInput;get image(){return this.parent.metaImage}set image(t){this.parent.metaImage=t}sortOrderMenu;get sortOrder(){return this.parent.sortingOrder}set sortOrder(t){this.parent.sortingOrder=t}addStepBtn;changeEvtObj;dropdownEvtObj;addStepEvtObj;constructor(t){super(),this.parent=t,this.changeEvtObj={change:this.updateFromInput_bound},this.dropdownEvtObj={dropdownInput:this.updateFromInput_bound},this.addStepEvtObj={activate:t.addStep_bound.bind(t,void 0,void 0)},this.main=document.getElementById("steps-builder-container");const e=this.main.querySelector("div.builder-steps-steps-container");this.parent.stepContainers["1st-party"]=e;const n={onSort:this.onSort_bound,onAdd:this.onAdd_bound,onRemove:this.onRemove_bound};this.sortable=new R(e,Object.assign(n,sortableSettings_steps)),this.nameInput=this.main.querySelector("input.builder-steps-mod-name"),v(this.nameInput,this.changeEvtObj),this.imageInput=this.main.querySelector(".builder-steps-mod-image input"),v(this.imageInput,this.changeEvtObj),this.sortOrderMenu=this.main.querySelector("menu.bcd-dropdown-sorting-order"),v(this.sortOrderMenu,this.dropdownEvtObj),this.addStepBtn=this.main.querySelector("button.builder-steps-add-child-btn"),v(this.addStepBtn,this.addStepEvtObj),F(this.main,this,null,!1,!0)}updateFromInput_(){this.name=this.nameInput.value,this.image=this.imageInput.value;const t=this.sortOrderMenu.upgrades?.getExtends(M)?.[0];t&&(this.sortOrder=O.translateDropdown(t.selectedOption))}update_(){this.nameInput.value=this.name,this.nameInput.dispatchEvent(new Event("input")),this.imageInput.value=this.image,this.imageInput.dispatchEvent(new Event("input")),this.sortOrderMenu.upgrades?.getExtends(M)?.[0]?.selectByString(O.translateDropdown(this.sortOrder)),this.updateCard()}async destroy_(){T(this.nameInput,this.changeEvtObj),T(this.imageInput,this.changeEvtObj),T(this.sortOrderMenu,this.dropdownEvtObj),T(this.addStepBtn,this.addStepEvtObj),this.nameInput.value="",this.imageInput.value="",this.sortOrderMenu.upgrades?.getExtends(M)?.[0]?.selectByString(window.FOMODBuilder.storage.settings.defaultSortingOrder)}}I.addUpdateObjects(I.Fomod,Fomod);const k=document.getElementById("builder-main-steps-step").content.firstElementChild;export class Step extends L{parent;get parentGroup(){return this.parent.inherited?.parent?.steps}get childClass(){return Group}get children(){return this.parent.groups}get childrenContainer(){return this.parent.groupContainers["1st-party"]}nameDisplay;groupCountDisplay;optionCountDisplay;get name(){return this.parent.name}set name(t){this.parent.name=t}nameInput;get sortOrder(){return this.parent.sortingOrder}set sortOrder(t){this.parent.sortingOrder=t}sortOrderMenu;addGroupBtn;constructor(t){super(),this.parent=t,this.main=k.cloneNode(!0);const e=this.main.querySelector("div.builder-steps-group-container");this.parent.groupContainers["1st-party"]=e;const n={onSort:this.onSort_bound,onAdd:this.onAdd_bound,onRemove:this.onRemove_bound};this.sortable=new R(e,Object.assign(n,sortableSettings_groups)),this.nameInput=this.main.querySelector("input.bcd-builder-input"),v(this.nameInput,{change:this.updateFromInput_bound}),this.sortOrderMenu=this.main.querySelector("menu.bcd-dropdown-sorting-order"),v(this.sortOrderMenu,{dropdownInput:this.updateFromInput_bound}),this.addGroupBtn=this.main.querySelector("button.builder-steps-add-child-btn"),v(this.addGroupBtn,{activate:t.addGroup_bound.bind(t,void 0,void 0)}),this.nameDisplay=this.main.querySelector(".builder-steps-step-title span.name"),this.groupCountDisplay=this.main.querySelector("span.builder-steps-step-group-count"),this.optionCountDisplay=this.main.querySelector("span.builder-steps-step-option-count"),this.deleteButton=U.cloneNode(!0),this.main.insertBefore(this.deleteButton,this.main.firstElementChild);const i=H.cloneNode(!0);this.main.insertBefore(i,this.main.firstElementChild),v(this.deleteButton,{activate:t.destroy.bind(t)});const s=this.parent.inherited.containers?.["1st-party"];s?(s.appendChild(this.main),this.animateIn(s),F(this.main,this,null,!1,!0),j.upgradeElements(this.main)):console.warn("Step container not found!")}update_(){this.nameInput.value=this.name,this.nameInput.dispatchEvent(new Event("input")),this.sortOrderMenu.upgrades?.getExtends(M)?.[0]?.selectByString(O.translateDropdown(this.sortOrder)),this.nameDisplay.textContent=this.name,G(this.groupCountDisplay,this.parent.groups.size),G(this.optionCountDisplay,[...this.parent.groups].reduce((t,e)=>t+e.options.size,0)),this.updateCard()}updateFromInput_(){this.name=this.nameInput.value;const t=this.sortOrderMenu.upgrades?.getExtends(M)?.[0];t&&(this.sortOrder=O.translateDropdown(t.selectedOption)),this.nameDisplay.textContent=this.name}}I.addUpdateObjects(I.Step,Step);const W=document.getElementById("builder-main-steps-group").content.firstElementChild;export class Group extends L{parent;get parentGroup(){return this.parent.inherited?.parent?.groups}get childClass(){return Option}get children(){return this.parent.options}get childrenContainer(){return this.parent.optionContainers["1st-party"]}nameDisplay;optionCountDisplay;get name(){return this.parent.name}set name(t){this.parent.name=t}nameInput;get sortOrder(){return this.parent.sortingOrder}set sortOrder(t){this.parent.sortingOrder=t}sortOrderMenu;get selectionType(){return this.parent.type}set selectionType(t){this.parent.type=t}selectionTypeMenu;addOptionBtn;constructor(t){super(),this.parent=t,this.main=W.cloneNode(!0);const e=this.main.querySelector("div.builder-steps-option-container");this.parent.optionContainers["1st-party"]=e;const n={onSort:this.onSort_bound,onAdd:this.onAdd_bound,onRemove:this.onRemove_bound};this.sortable=new R(e,Object.assign(n,sortableSettings_options)),this.nameInput=this.main.querySelector("input.builder-steps-group-name"),v(this.nameInput,{change:this.updateFromInput_bound}),this.sortOrderMenu=this.main.querySelector("menu.bcd-dropdown-sorting-order"),v(this.sortOrderMenu,{dropdownInput:this.updateFromInput_bound}),this.selectionTypeMenu=this.main.querySelector("menu.bcd-dropdown-group-type"),v(this.selectionTypeMenu,{dropdownInput:this.updateFromInput_bound}),this.addOptionBtn=this.main.querySelector("button.builder-steps-add-child-btn"),v(this.addOptionBtn,{activate:t.addOption_bound.bind(t,void 0,void 0)}),this.nameDisplay=this.main.querySelector("span.name"),this.optionCountDisplay=this.main.querySelector("span.builder-steps-group-option-count"),this.deleteButton=U.cloneNode(!0),this.main.insertBefore(this.deleteButton,this.main.firstElementChild),v(this.deleteButton,{activate:t.destroy.bind(t)});const i=H.cloneNode(!0);this.main.insertBefore(i,this.main.firstElementChild);const s=this.parent.inherited.containers?.["1st-party"];s?(s.appendChild(this.main),this.animateIn(s),F(this.main,this,null,!1,!0),j.upgradeElements(this.main)):console.warn("Group container not found!")}update_(){this.nameInput.value=this.name,this.nameDisplay.textContent=this.name,this.sortOrderMenu.upgrades?.getExtends(M)?.[0]?.selectByString(O.translateDropdown(this.sortOrder)),this.selectionTypeMenu.upgrades?.getExtends(M)?.[0]?.selectByString(O.translateDropdown(this.selectionType)),this.nameDisplay.textContent=this.name,G(this.optionCountDisplay,this.parent.options.size),this.updateCard()}updateFromInput_(){this.name=this.nameInput.value;const t=this.sortOrderMenu.upgrades?.getExtends(M)?.[0];t&&(this.sortOrder=O.translateDropdown(t.selectedOption));const e=this.selectionTypeMenu.upgrades?.getExtends(M)?.[0];e&&(this.selectionType=O.translateDropdown(e.selectedOption)),this.nameDisplay.textContent=this.name}}I.addUpdateObjects(I.Group,Group);const P=document.getElementById("builder-main-steps-option").content.firstElementChild;export class Option extends L{parent;get parentGroup(){return this.parent.inherited?.parent?.options}get childClass(){return K}get children(){return this.parent.flagsToSet}get childrenContainer(){return this.parent.flagsContainers["1st-party"]}nameDisplay;fileCountDisplay;flagCountDisplay;get name(){return this.parent.name}set name(t){this.parent.name=t}nameInput;get description(){return this.parent.description}set description(t){this.parent.description=t}descriptionInput;get image(){return this.parent.image}set image(t){this.parent.image=t}imageInput;editStateConditionsButton;get defaultState(){return this.parent.typeDescriptor.defaultState}set defaultState(t){this.parent.typeDescriptor.defaultState=t}defaultStateDropdown;addFlagBtn;minimumChildrenToSort=0;addFlagEvtObj;constructor(t){super(),this.parent=t,this.addFlagEvtObj={activate:t.addFlag_bound.bind(t,void 0,void 0)},this.main=P.cloneNode(!0),this.nameInput=this.main.querySelector("input.builder-steps-option-name"),v(this.nameInput,{change:this.updateFromInput_bound}),this.descriptionInput=this.main.querySelector("textarea.builder-steps-option-description"),v(this.descriptionInput,{change:this.updateFromInput_bound}),this.imageInput=this.main.querySelector("input.js-relative-image-picker"),v(this.imageInput,{change:this.updateFromInput_bound}),this.editStateConditionsButton=this.main.querySelector("button.builder-steps-condition-edit-btn"),this.defaultStateDropdown=this.main.querySelector("menu.bcd-dropdown-option-state"),v(this.defaultStateDropdown,{dropdownInput:this.updateFromInput_bound}),this.nameDisplay=this.main.querySelector("span.name"),this.fileCountDisplay=this.main.querySelector("span.builder-steps-option-file-count"),this.flagCountDisplay=this.main.querySelector("span.builder-steps-option-flag-count"),this.deleteButton=U.cloneNode(!0),this.main.insertBefore(this.deleteButton,this.main.firstElementChild),v(this.deleteButton,{activate:t.destroy.bind(t)});const e=this.main.querySelector("div.builder-steps-option-set-flags-container");this.parent.flagsContainers["1st-party"]=e;const n={onSort:this.onSort_bound,onAdd:this.onAdd_bound,onRemove:this.onRemove_bound};this.sortable=new R(e,Object.assign(n,sortableSettings_flags)),this.addFlagBtn=this.main.querySelector(".builder-steps-option-set-flags-body button.builder-steps-add-child-btn"),v(this.addFlagBtn,this.addFlagEvtObj);const i=H.cloneNode(!0);this.main.insertBefore(i,this.main.firstElementChild);const s=this.parent.inherited.containers?.["1st-party"];s?(this.animateIn(s),s.appendChild(this.main),F(this.main,this,null,!1,!0),j.upgradeElements(this.main)):console.warn("Option container not found!")}update_(){this.nameInput.value=this.name||"",this.nameInput.dispatchEvent(new Event("change")),this.descriptionInput.value=this.description||"",this.descriptionInput.dispatchEvent(new Event("change")),this.imageInput.value=this.image||"",this.imageInput.dispatchEvent(new Event("change")),this.defaultStateDropdown.upgrades?.getExtends(M)?.[0]?.selectByString(O.translateDropdown(this.parent.typeDescriptor.defaultState)),this.nameDisplay.textContent=this.name||"",G(this.fileCountDisplay,this.parent.files.size),G(this.flagCountDisplay,this.parent.flagsToSet.size),this.updateCard()}updateFromInput_(){this.name=this.nameInput.value||"",this.description=this.descriptionInput.value||"",this.image=this.imageInput.value||"";const t=this.defaultStateDropdown.upgrades?.getExtends(M)?.[0];t&&(this.parent.typeDescriptor.defaultState=O.translateDropdown(t.selectedOption)),this.nameDisplay.textContent=this.name}}I.addUpdateObjects(I.Option,Option);const J=document.getElementById("builder-steps-flag-template").content.firstElementChild;class K extends L{parent;get parentGroup(){return this.parent.inherited?.parent?.flagsToSet}children;childrenContainer;childClass;get name(){return this.parent.flag}set name(t){this.parent.flag=t}nameInput;get value(){return this.parent.value}set value(t){this.parent.value=t}valueInput;minimumItemsToSort=0;constructor(t){super(),this.parent=t,this.main=J.cloneNode(!0),this.nameInput=this.main.querySelector(".builder-steps-flag-name input"),v(this.nameInput,{change:this.updateFromInput_bound}),this.valueInput=this.main.querySelector(".builder-steps-flag-value input"),v(this.valueInput,{change:this.updateFromInput_bound}),this.deleteButton=U.cloneNode(!0),this.main.insertBefore(this.deleteButton,this.main.firstElementChild),v(this.deleteButton,{activate:t.destroy.bind(t)});const e=H.cloneNode(!0);this.main.insertBefore(e,this.main.firstElementChild);const n=this.parent.inherited?.containers?.["1st-party"];n?(n.appendChild(this.main),this.animateIn(n),F(this.main,this,null,!1,!0),j.upgradeElements(this.main)):console.warn("Flag container not found!")}update_(){this.nameInput.value=this.name,this.nameInput.dispatchEvent(new Event("change")),this.valueInput.value=this.value,this.valueInput.dispatchEvent(new Event("change")),this.updateCard()}updateFromInput_(){this.name=this.nameInput.value,this.value=this.valueInput.value}}I.addUpdateObjects(I.DependencyFlag,K);
//# sourceMappingURL=https://raw.githubusercontent.com/BellCubeDev/site-testing/deployment/tools/fomod/fomod-builder-steps-1st-party.js.map