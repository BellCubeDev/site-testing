import * as bcdUniversal from '../../universal.js';
import * as fomod from './fomod-builder.js';
import './fomod-builder-bindings.js';
import './fomod-builder-steps-1st-party.js';
import './fomod-builder-steps-vortex.js';
import './fomod-builder-steps-mo2.js';
import * as bcdFS from '../../filesystem-interface.js';
import * as xml from './fomod-builder-xml-translator.js';
import pluralize_ from '../../included_node_modules/plural/index.js';
const pluralize = pluralize_;
import vkBeautify_ from '../../included_node_modules/vkbeautify/index.js';
const vkBeautify = vkBeautify_;
export function updatePluralDisplay(element, count) {
    element.textContent = count + ' ' + pluralize(element.getAttribute('unitWord') ?? '', count);
}
export var DropdownToLang;
(function (DropdownToLang) {
    DropdownToLang["Explicit"] = "Manual";
    DropdownToLang["Ascending"] = "Alphabetical";
    DropdownToLang["Descending"] = "Reverse Alphabetical";
    DropdownToLang["SelectAny"] = "Allow Any Selections";
    DropdownToLang["SelectAll"] = "Force-Select Everything";
    DropdownToLang["SelectExactlyOne"] = "Require Exactly One Selection";
    DropdownToLang["SelectAtMostOne"] = "Require One or No Selections";
    DropdownToLang["SelectAtLeastOne"] = "Require At Least One Selection";
    DropdownToLang["NotUsable"] = "Not Useable";
    DropdownToLang["CouldBeUsable"] = "Could Be Useable";
})(DropdownToLang || (DropdownToLang = {}));
export var LangToDropdown;
(function (LangToDropdown) {
    LangToDropdown["Manual"] = "Explicit";
    LangToDropdown["Alphabetical"] = "Ascending";
    LangToDropdown["Reverse Alphabetical"] = "Descending";
    LangToDropdown["Allow Any Selections"] = "SelectAny";
    LangToDropdown["Force-Select Everything"] = "SelectAll";
    LangToDropdown["Require Exactly One Selection"] = "SelectExactlyOne";
    LangToDropdown["Require One or No Selections"] = "SelectAtMostOne";
    LangToDropdown["Require At Least One Selection"] = "SelectAtLeastOne";
    LangToDropdown["Not Useable"] = "NotUsable";
    LangToDropdown["Could Be Useable"] = "CouldBeUsable";
})(LangToDropdown || (LangToDropdown = {}));
export function translateDropdown(str) {
    if (typeof str !== 'string')
        return str;
    if (str in DropdownToLang)
        return DropdownToLang[str];
    if (str in LangToDropdown)
        return LangToDropdown[str];
    return str;
}
export class BCDDropdownSortingOrder extends bcdUniversal.BCDDropdown {
    static asString = 'FOMOD Builder - Sorting Order Dropdown';
    static cssClass = 'bcd-dropdown-sorting-order';
    constructor(element) {
        super(element, element.previousElementSibling, true);
    }
    options() {
        return {
            'Manual': null,
            'Alphabetical': null,
            'Reverse Alphabetical': null
        };
    }
}
export class BCDDropdownGroupType extends bcdUniversal.BCDDropdown {
    static asString = 'FOMOD Builder - Group Type Dropdown';
    static cssClass = 'bcd-dropdown-group-type';
    constructor(element) {
        super(element, element.previousElementSibling, true);
    }
    options() {
        return {
            "Allow Any Selections": null,
            "Force-Select Everything": null,
            "Require Exactly One Selection": null,
            "Require One or No Selections": null,
            "Require At Least One Selection": null,
        };
    }
}
export class BCDDropdownOptionState extends bcdUniversal.BCDDropdown {
    static asString = 'FOMOD Builder - Option State Dropdown';
    static cssClass = 'bcd-dropdown-option-state';
    constructor(element) {
        super(element, element.previousElementSibling, true);
    }
    options() {
        return {
            "Optional": null,
            "Recommended": null,
            "Could Be Useable": null,
            "Required": null,
            "Not Useable": null
        };
    }
}
let firstSetEditor = true;
export function setStepEditorType(type) {
    const workingEditors = ['builder'];
    if (!workingEditors.includes(type))
        type = 'builder';
    const thisElem = document.getElementById(`steps-${type}-container`);
    const otherSteps = thisElem.parentElement.querySelectorAll(`.fomod-editor-type:not(#steps-${type}-container)${firstSetEditor ? '' : '.active'}`);
    if (!firstSetEditor && thisElem.classList.contains('.active'))
        return;
    if (type !== 'builder') {
        if (!window.lazyStylesLoaded)
            thisElem.classList.add('needs-lazy');
        else
            thisElem.classList.remove('needs-lazy');
    }
    function transitionPhaseTwo() {
        otherSteps.forEach(e => {
            e.classList.remove('active_');
            e.removeEventListener('transitionend', transitionPhaseTwo);
            e.ariaHidden = 'true';
            e.setAttribute('hidden', '');
        });
        thisElem.classList.add('active_');
        thisElem.ariaHidden = 'false';
        thisElem.removeAttribute('hidden');
        bcdUniversal.nestAnimationFrames(2, () => {
            thisElem.classList.add('active');
        });
    }
    if (otherSteps.length === 0)
        transitionPhaseTwo();
    else {
        otherSteps.forEach(e => {
            e.classList.remove('active');
            e.addEventListener('transitionend', transitionPhaseTwo, { once: true });
        });
        setTimeout(transitionPhaseTwo, 200);
    }
    firstSetEditor = false;
    window.FOMODBuilder.storage.preferences.stepsBuilder = type;
}
export async function showOpenAnotherFolderDialog() {
    const dialog = document.getElementById('opening-other-project-modal').upgrades.getExtends(bcdUniversal.BCDModalDialog)[0];
    const result = await dialog.show();
    if (result !== 'confirm') {
        console.debug(`User cancelled opening another folder with response "${result}"`);
        return false;
    }
    else {
        console.debug(`User confirmed opening another folder with response "${result}"`);
        return true;
    }
}
let tabList = null;
export async function openFolder(test = false) {
    if (loadingFomod.state)
        return;
    if ((window.FOMODBuilder.directory || window.FOMODBuilder.trackedFomod) && !await showOpenAnotherFolderDialog())
        return;
    if (test) {
        loadingFomod.state = true;
        window.loadTestFOMOD();
        postLoad();
        return;
    }
    if ('showDirectoryPicker' in window)
        return await openFolder_entry();
    postLoad(false);
    console.warn('No directory picker available for your system!');
    fomod.getNoSupportModal()?.show();
}
export async function postLoad(loaded = true) {
    await bcdUniversal.wait(100);
    loadingFomod.state = false;
    tabList ??= document.getElementById('tablist');
    if (loaded) {
        tabList.removeAttribute('disabled');
        tabList.classList.remove('tabs-list-container--hidden');
    }
    else {
        tabList.setAttribute('disabled', '');
        tabList.classList.add('tabs-list-container--hidden');
    }
}
export const loadingFomod = { state: false };
export async function openFolder_entry() {
    if (loadingFomod.state)
        return;
    loadingFomod.state = true;
    console.debug('Opening a folder!');
    const picked = await bcdFS.getUserPickedFolder(true);
    if (!picked)
        return loadingFomod.state = false;
    console.debug('Picked folder:', picked);
    console.debug('Picked folder name:', picked?.handle.name);
    console.debug('Picked folder perms?', await picked?.handle.queryPermission({ mode: 'readwrite' }));
    window.FOMODBuilder.directory = picked;
    const fomodDir = await picked.childDirsC['fomod'];
    const moduleStr_ = fomodDir.childFilesC['ModuleConfig.xml'].then(file => file.readAsText());
    const infoStr_ = fomodDir.childFilesC['Info.xml'].then(file => file.readAsText());
    const [moduleStr, infoStr] = await Promise.all([moduleStr_, infoStr_]);
    xml.translateWhole(moduleStr, infoStr, true);
    postLoad();
}
export async function setOutputElements() {
    if (saving)
        return;
    saving = true;
    if (!window.FOMODBuilder.trackedFomod)
        throw new Error('No FOMOD is currently loaded.');
    const infoDoc = window.FOMODBuilder.trackedFomod.infoDoc;
    const moduleDoc = window.FOMODBuilder.trackedFomod.moduleDoc;
    let infoString = window.FOMODBuilder.trackedFomod.obj.asInfoXML(infoDoc).outerHTML || '<!-- ERROR - Serialized document was empty! -->';
    if (window.FOMODBuilder.storage.settings.formatXML)
        infoString = vkBeautify.xml(infoString);
    else
        infoString = vkBeautify.xmlmin(infoString, true);
    console.log({ infoString });
    document.getElementById('info-xml').textContent = infoString;
    let moduleString = window.FOMODBuilder.trackedFomod.obj.asModuleXML(moduleDoc).outerHTML || '<!-- ERROR - Serialized document was empty! -->';
    if (window.FOMODBuilder.storage.settings.formatXML)
        moduleString = vkBeautify.xml(moduleString);
    else
        moduleString = vkBeautify.xmlmin(moduleString, true);
    console.log({ moduleString });
    document.getElementById('module-xml').textContent = moduleString;
    saving = false;
}
function formatXml(string) {
    if (window.FOMODBuilder.storage.settings.formatXML)
        return vkBeautify.xml(string);
    else
        return vkBeautify.xmlmin(string, true);
}
let saving = false;
export async function save() {
    if (saving)
        return;
    saving = true;
    if (!window.FOMODBuilder.trackedFomod)
        throw new Error('No FOMOD is currently loaded.');
    if (!window.FOMODBuilder.directory) {
        await setOutputElements();
        return saving = false;
    }
    const fomodFolder = (await window.FOMODBuilder.directory.childDirsC['fomod']);
    const fomodInfo_ = fomodFolder.childFilesC['Info.xml'];
    const fomodModule_ = fomodFolder.childFilesC['ModuleConfig.xml'];
    const [fomodInfo, fomodModule] = await Promise.all([fomodInfo_, fomodModule_]);
    const infoDoc = window.FOMODBuilder.trackedFomod.infoDoc;
    const infoString = formatXml(window.FOMODBuilder.trackedFomod.obj.asInfoXML(infoDoc).outerHTML || '<!-- ERROR - Serialized document was empty! -->');
    const writeInfoPromise = fomodInfo.write(infoString);
    console.log({ infoString });
    const moduleDoc = window.FOMODBuilder.trackedFomod.moduleDoc;
    const moduleString = formatXml(window.FOMODBuilder.trackedFomod.obj.asModuleXML(moduleDoc).outerHTML || '<!-- ERROR - Serialized document was empty! -->');
    const writeModulePromise = fomodModule.write(moduleString);
    console.log({ moduleString });
    await Promise.all([writeInfoPromise, writeModulePromise]);
    hasUnsavedChanges = false;
    saving = false;
}
export async function cleanSave() {
    if (saving)
        return;
    if (!window.FOMODBuilder.trackedFomod)
        throw new Error('No FOMOD is currently loaded.');
    window.FOMODBuilder.trackedFomod.infoDoc = window.domParser.parseFromString('<fomod/>', 'text/xml');
    window.FOMODBuilder.trackedFomod.moduleDoc = window.domParser.parseFromString('<config/>', 'text/xml');
    return await save();
}
let saveTimeout = null;
let hasUnsavedChanges = false;
export function autoSave() {
    if (saving || loadingFomod.state)
        return;
    if (!window.FOMODBuilder.trackedFomod)
        return;
    hasUnsavedChanges = true;
    if (!window.FOMODBuilder.storage.settings.autoSaveAfterChange)
        return;
    if (saveTimeout !== null)
        clearTimeout(saveTimeout);
    saveTimeout = bcdUniversal.afterDelay(500, () => {
        saveTimeout = null;
        if (window.FOMODBuilder.storage.settings.autoCleanSave)
            cleanSave();
        else
            save();
    });
}
window.addEventListener('beforeunload', (event) => {
    if (!hasUnsavedChanges)
        return;
    event.preventDefault();
    event.returnValue = '';
    return '';
});
export function init() {
    bcdUniversal.registerBCDComponents(BCDDropdownSortingOrder, BCDDropdownOptionState, BCDDropdownGroupType);
    setStepEditorType(window.FOMODBuilder.storage.preferences.stepsBuilder);
    window.fomodUndoManager = fomodUndoManager;
    window.registerForEvents(document, {
        save: () => save(),
    });
    console.log('FOMOD Builder UI initialized.');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9tb2QtYnVpbGRlci11aS5qcyIsInNvdXJjZVJvb3QiOiJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vQmVsbEN1YmVEZXYvc2l0ZS10ZXN0aW5nL2RlcGxveW1lbnQvIiwic291cmNlcyI6WyJ0b29scy9mb21vZC9mb21vZC1idWlsZGVyLXVpLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sS0FBSyxZQUFZLE1BQU0sb0JBQW9CLENBQUM7QUFHbkQsT0FBTyxLQUFLLEtBQUssTUFBTSxvQkFBb0IsQ0FBQztBQUU1QyxPQUFPLDZCQUE2QixDQUFDO0FBQ3JDLE9BQU8sb0NBQW9DLENBQUM7QUFDNUMsT0FBTyxpQ0FBaUMsQ0FBQztBQUN6QyxPQUFPLDhCQUE4QixDQUFDO0FBRXRDLE9BQU8sS0FBSyxLQUFLLE1BQU0sK0JBQStCLENBQUM7QUFDdkQsT0FBTyxLQUFLLEdBQUcsTUFBTSxtQ0FBbUMsQ0FBQztBQUd6RCxPQUFPLFVBQVUsTUFBTSw2Q0FBNkMsQ0FBQztBQUNyRSxNQUFNLFNBQVMsR0FBRyxVQUFxRCxDQUFDO0FBRXhFLE9BQU8sV0FBVyxNQUFNLGlEQUFpRCxDQUFDO0FBRzFFLE1BQU0sVUFBVSxHQUFHLFdBQTZDLENBQUM7QUFFakUsTUFBTSxVQUFVLG1CQUFtQixDQUFDLE9BQWdCLEVBQUUsS0FBYTtJQUUvRCxPQUFPLENBQUMsV0FBVyxHQUFHLEtBQUssR0FBRyxHQUFHLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ2pHLENBQUM7QUFFRCxNQUFNLENBQU4sSUFBWSxjQWFYO0FBYkQsV0FBWSxjQUFjO0lBQ3RCLHFDQUFtQixDQUFBO0lBQ25CLDRDQUEwQixDQUFBO0lBQzFCLHFEQUFtQyxDQUFBO0lBRW5DLG9EQUFrQyxDQUFBO0lBQ2xDLHVEQUFxQyxDQUFBO0lBQ3JDLG9FQUFrRCxDQUFBO0lBQ2xELGtFQUFn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LENBQUMsV0FBVyxDQUFDLENBQUM7SUFDcEQsV0FBVyxHQUFHLFlBQVksQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRTtRQUM1QyxXQUFXLEdBQUcsSUFBSSxDQUFDO1FBQ25CLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLGFBQWE7WUFBRSxTQUFTLEVBQUUsQ0FBQzs7WUFDL0QsSUFBSSxFQUFFLENBQUM7SUFDaEIsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsTUFBTSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO0lBQzlDLElBQUksQ0FBQyxpQkFBaUI7UUFBRSxPQUFPO0lBRS9CLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUN2QixLQUFLLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQztJQUN2QixPQUFPLEVBQUUsQ0FBQztBQUNkLENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxVQUFVLElBQUk7SUFDaEIsWUFBWSxDQUFDLHFCQUFxQixDQUFDLHVCQUF1QixFQUFFLHNCQUFzQixFQUFFLG9CQUFvQixDQUFDLENBQUM7SUFDMUcsaUJBQWlCLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBR3hFLE1BQU0sQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztJQUUzQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsUUFBUSxFQUFFO1FBQy9CLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLEVBQUU7S0FDckIsQ0FBQyxDQUFDO0lBRUgsT0FBTyxDQUFDLEdBQUcsQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0FBQ2pELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBpbXBvcnQvZmlyc3QgKi9cbmltcG9ydCAqIGFzIG1kbCBmcm9tICcuLi8uLi9hc3NldHMvc2l0ZS9tZGwvbWF0ZXJpYWwuanMnO1xuaW1wb3J0ICogYXMgYmNkVW5pdmVyc2FsIGZyb20gJy4uLy4uL3VuaXZlcnNhbC5qcyc7XG5cbmltcG9ydCAqIGFzIGZvbW9kQ2xhc3NlcyBmcm9tICcuL2ZvbW9kLWJ1aWxkZXItY2xhc3NpZmljYXRpb25zLmpzJztcbmltcG9ydCAqIGFzIGZvbW9kIGZyb20gJy4vZm9tb2QtYnVpbGRlci5qcyc7XG5cbmltcG9ydCAnLi9mb21vZC1idWlsZGVyLWJpbmRpbmdzLmpzJztcbmltcG9ydCAnLi9mb21vZC1idWlsZGVyLXN0ZXBzLTFzdC1wYXJ0eS5qcyc7XG5pbXBvcnQgJy4vZm9tb2QtYnVpbGRlci1zdGVwcy12b3J0ZXguanMnO1xuaW1wb3J0ICcuL2ZvbW9kLWJ1aWxkZXItc3RlcHMtbW8yLmpzJztcblxuaW1wb3J0ICogYXMgYmNkRlMgZnJvbSAnLi4vLi4vZmlsZXN5c3RlbS1pbnRlcmZhY2UuanMnO1xuaW1wb3J0ICogYXMgeG1sIGZyb20gJy4vZm9tb2QtYnVpbGRlci14bWwtdHJhbnNsYXRvci5qcyc7XG5cblxuaW1wb3J0IHBsdXJhbGl6ZV8gZnJvbSAnLi4vLi4vaW5jbHVkZWRfbm9kZV9tb2R1bGVzL3BsdXJhbC9pbmRleC5qcyc7XG5jb25zdCBwbHVyYWxpemUgPSBwbHVyYWxpemVfIGFzICh3b3JkOiBzdHJpbmcsIGNvdW50OiBudW1iZXIpID0+IHN0cmluZztcblxuaW1wb3J0IHZrQmVhdXRpZnlfIGZyb20gJy4uLy4uL2luY2x1ZGVkX25vZGVfbW9kdWxlcy92a2JlYXV0aWZ5L2luZGV4LmpzJztcbmltcG9ydCB0eXBlIHZrQmVhdXRpZnlfXyBmcm9tICcuLi8uLi8uLi9ub2RlX21vZHVsZXMvQHR5cGVzL3ZrYmVhdXRpZnkvaW5kZXgnO1xuXG5jb25zdCB2a0JlYXV0aWZ5ID0gdmtCZWF1dGlmeV8gYXMgdW5rbm93biBhcyB0eXBlb2YgdmtCZWF1dGlmeV9fO1xuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlUGx1cmFsRGlzcGxheShlbGVtZW50OiBFbGVtZW50LCBjb3VudDogbnVtYmVyKSB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci10ZW1wbGF0ZVxuICAgIGVsZW1lbnQudGV4dENvbnRlbnQgPSBjb3VudCArICcgJyArIHBsdXJhbGl6ZShlbGVtZW50LmdldEF0dHJpYnV0ZSgndW5pdFdvcmQnKSA/PyAnJywgY291bnQpO1xufVxuXG5leHBvcnQgZW51bSBEcm9wZG93blRvTGFuZyB7XG4gICAgRXhwbGljaXQgPSBcIk1hbnVhbFwiLFxuICAgIEFzY2VuZGluZyA9IFwiQWxwaGFiZXRpY2FsXCIsXG4gICAgRGVzY2VuZGluZyA9IFwiUmV2ZXJzZSBBbHBoYWJldGljYWxcIixcblxuICAgIFNlbGVjdEFueSA9IFwiQWxsb3cgQW55IFNlbGVjdGlvbnNcIixcbiAgICBTZWxlY3RBbGwgPSBcIkZvcmNlLVNlbGVjdCBFdmVyeXRoaW5nXCIsXG4gICAgU2VsZWN0RXhhY3RseU9uZSA9IFwiUmVxdWlyZSBFeGFjdGx5IE9uZSBTZWxlY3Rpb25cIixcbiAgICBTZWxlY3RBdE1vc3RPbmUgPSBcIlJlcXVpcmUgT25lIG9yIE5vIFNlbGVjdGlvbnNcIixcbiAgICBTZWxlY3RBdExlYXN0T25lID0gXCJSZXF1aXJlIEF0IExlYXN0IE9uZSBTZWxlY3Rpb25cIixcblxuICAgIE5vdFVzYWJsZSA9IFwiTm90IFVzZWFibGVcIixcbiAgICBDb3VsZEJlVXNhYmxlID0gXCJDb3VsZCBCZSBVc2VhYmxlXCIsXG59XG5cbmV4cG9ydCBlbnVtIExhbmdUb0Ryb3Bkb3duIHtcbiAgICBNYW51YWwgPSBcIkV4cGxpY2l0XCIsXG4gICAgQWxwaGFiZXRpY2FsID0gXCJBc2NlbmRpbmdcIixcbiAgICBcIlJldmVyc2UgQWxwaGFiZXRpY2FsXCIgPSBcIkRlc2NlbmRpbmdcIixcblxuICAgIFwiQWxsb3cgQW55IFNlbGVjdGlvbnNcIiA9IFwiU2VsZWN0QW55XCIsXG4gICAgXCJGb3JjZS1TZWxlY3QgRXZlcnl0aGluZ1wiID0gXCJTZWxlY3RBbGxcIixcbiAgICBcIlJlcXVpcmUgRXhhY3RseSBPbmUgU2VsZWN0aW9uXCIgPSBcIlNlbGVjdEV4YWN0bHlPbmVcIixcbiAgICBcIlJlcXVpcmUgT25lIG9yIE5vIFNlbGVjdGlvbnNcIiA9IFwiU2VsZWN0QXRNb3N0T25lXCIsXG4gICAgXCJSZXF1aXJlIEF0IExlYXN0IE9uZSBTZWxlY3Rpb25cIiA9IFwiU2VsZWN0QXRMZWFzdE9uZVwiLFxuXG4gICAgXCJOb3QgVXNlYWJsZVwiID0gXCJOb3RVc2FibGVcIixcbiAgICBcIkNvdWxkIEJlIFVzZWFibGVcIiA9IFwiQ291bGRCZVVzYWJsZVwiLFxufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiB0cmFuc2xhdGVEcm9wZG93bihzdHI6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKHR5cGVvZiBzdHIgIT09ICdzdHJpbmcnKSByZXR1cm4gc3RyO1xuICAgIGlmIChzdHIgaW4gRHJvcGRvd25Ub0xhbmcpIHJldHVybiBEcm9wZG93blRvTGFuZ1tzdHIgYXMga2V5b2YgdHlwZW9mIERyb3Bkb3duVG9MYW5nXTtcbiAgICBpZiAoc3RyIGluIExhbmdUb0Ryb3Bkb3duKSByZXR1cm4gTGFuZ1RvRHJvcGRvd25bc3RyIGFzIGtleW9mIHR5cGVvZiBMYW5nVG9Ecm9wZG93bl07XG4gICAgcmV0dXJuIHN0cjtcbn1cblxuXG5leHBvcnQgY2xhc3MgQkNERHJvcGRvd25Tb3J0aW5nT3JkZXIgZXh0ZW5kcyBiY2RVbml2ZXJzYWwuQkNERHJvcGRvd24ge1xuICAgIHN0YXRpYyByZWFkb25seSBhc1N0cmluZyA9ICdGT01PRCBCdWlsZGVyIC0gU29ydGluZyBPcmRlciBEcm9wZG93bic7XG4gICAgc3RhdGljIHJlYWRvbmx5IGNzc0NsYXNzID0gJ2JjZC1kcm9wZG93bi1zb3J0aW5nLW9yZGVyJztcblxuICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQ6IEVsZW1lbnQpIHtcbiAgICAgICAgc3VwZXIoZWxlbWVudCwgZWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nISwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgb3ZlcnJpZGUgb3B0aW9ucygpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdNYW51YWwnOiBudWxsLFxuICAgICAgICAgICAgJ0FscGhhYmV0aWNhbCc6IG51bGwsXG4gICAgICAgICAgICAnUmV2ZXJzZSBBbHBoYWJldGljYWwnOiBudWxsXG4gICAgICAgIH07XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgQkNERHJvcGRvd25Hcm91cFR5cGUgZXh0ZW5kcyBiY2RVbml2ZXJzYWwuQkNERHJvcGRvd24ge1xuICAgIHN0YXRpYyByZWFkb25seSBhc1N0cmluZyA9ICdGT01PRCBCdWlsZGVyIC0gR3JvdXAgVHlwZSBEcm9wZG93bic7XG4gICAgc3RhdGljIHJlYWRvbmx5IGNzc0NsYXNzID0gJ2JjZC1kcm9wZG93bi1ncm91cC10eXBlJztcblxuICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQ6IEVsZW1lbnQpIHtcbiAgICAgICAgc3VwZXIoZWxlbWVudCwgZWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nISwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgb3ZlcnJpZGUgb3B0aW9ucygpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIFwiQWxsb3cgQW55IFNlbGVjdGlvbnNcIjogbnVsbCxcbiAgICAgICAgICAgIFwiRm9yY2UtU2VsZWN0IEV2ZXJ5dGhpbmdcIjogbnVsbCxcbiAgICAgICAgICAgIFwiUmVxdWlyZSBFeGFjdGx5IE9uZSBTZWxlY3Rpb25cIjogbnVsbCxcbiAgICAgICAgICAgIFwiUmVxdWlyZSBPbmUgb3IgTm8gU2VsZWN0aW9uc1wiOiBudWxsLFxuICAgICAgICAgICAgXCJSZXF1aXJlIEF0IExlYXN0IE9uZSBTZWxlY3Rpb25cIjogbnVsbCxcbiAgICAgICAgfTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBCQ0REcm9wZG93bk9wdGlvblN0YXRlIGV4dGVuZHMgYmNkVW5pdmVyc2FsLkJDRERyb3Bkb3duIHtcbiAgICBzdGF0aWMgcmVhZG9ubHkgYXNTdHJpbmcgPSAnRk9NT0QgQnVpbGRlciAtIE9wdGlvbiBTdGF0ZSBEcm9wZG93bic7XG4gICAgc3RhdGljIHJlYWRvbmx5IGNzc0NsYXNzID0gJ2JjZC1kcm9wZG93bi1vcHRpb24tc3RhdGUnO1xuXG4gICAgY29uc3RydWN0b3IoZWxlbWVudDogRWxlbWVudCkge1xuICAgICAgICBzdXBlcihlbGVtZW50LCBlbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmchLCB0cnVlKTtcbiAgICB9XG5cbiAgICBvdmVycmlkZSBvcHRpb25zKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgXCJPcHRpb25hbFwiOiBudWxsLFxuICAgICAgICAgICAgXCJSZWNvbW1lbmRlZFwiOiBudWxsLFxuICAgICAgICAgICAgXCJDb3VsZCBCZSBVc2VhYmxlXCI6IG51bGwsXG4gICAgICAgICAgICBcIlJlcXVpcmVkXCI6IG51bGwsXG4gICAgICAgICAgICBcIk5vdCBVc2VhYmxlXCI6IG51bGxcbiAgICAgICAgfTtcbiAgICB9XG59XG5cblxuXG5leHBvcnQgaW50ZXJmYWNlIFdpbmRvd1VJIHtcbiAgICBvcGVuRm9sZGVyOiB0eXBlb2Ygb3BlbkZvbGRlcjtcbiAgICBzYXZlOiB0eXBlb2Ygc2F2ZTtcbiAgICBjbGVhblNhdmU6IHR5cGVvZiBjbGVhblNhdmU7XG4gICAgYXR0ZW1wdFJlcGFpcjogKCkgPT4gdW5rbm93bjtcbiAgICBzZXRTdGVwRWRpdG9yVHlwZTogdHlwZW9mIHNldFN0ZXBFZGl0b3JUeXBlO1xufVxuXG5cbmV4cG9ydCB0eXBlIEJDREJ1aWxkZXJUeXBlID0gJ2J1aWxkZXInfCd2b3J0ZXgnfCdtbzInO1xuXG5sZXQgZmlyc3RTZXRFZGl0b3IgPSB0cnVlO1xuZXhwb3J0IGZ1bmN0aW9uIHNldFN0ZXBFZGl0b3JUeXBlKHR5cGU6IEJDREJ1aWxkZXJUeXBlKSB7XG5cbiAgICBjb25zdCB3b3JraW5nRWRpdG9ycyA9IFsnYnVpbGRlciddO1xuICAgIGlmICghd29ya2luZ0VkaXRvcnMuaW5jbHVkZXModHlwZSkpIHR5cGUgPSAnYnVpbGRlcic7XG5cblxuICAgIGNvbnN0IHRoaXNFbGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYHN0ZXBzLSR7dHlwZX0tY29udGFpbmVyYCkhO1xuICAgIGNvbnN0IG90aGVyU3RlcHMgPSB0aGlzRWxlbS5wYXJlbnRFbGVtZW50IS5xdWVyeVNlbGVjdG9yQWxsKGAuZm9tb2QtZWRpdG9yLXR5cGU6bm90KCNzdGVwcy0ke3R5cGV9LWNvbnRhaW5lcikke2ZpcnN0U2V0RWRpdG9yID8gJycgOiAnLmFjdGl2ZSd9YCkhO1xuXG4gICAgaWYgKCFmaXJzdFNldEVkaXRvciAmJiB0aGlzRWxlbS5jbGFzc0xpc3QuY29udGFpbnMoJy5hY3RpdmUnKSkgcmV0dXJuO1xuXG4gICAgaWYgKHR5cGUgIT09ICdidWlsZGVyJykge1xuICAgICAgICBpZiAoIXdpbmRvdy5sYXp5U3R5bGVzTG9hZGVkKSB0aGlzRWxlbS5jbGFzc0xpc3QuYWRkKCduZWVkcy1sYXp5Jyk7XG4gICAgICAgIGVsc2UgdGhpc0VsZW0uY2xhc3NMaXN0LnJlbW92ZSgnbmVlZHMtbGF6eScpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHRyYW5zaXRpb25QaGFzZVR3bygpIHtcbiAgICAgICAgb3RoZXJTdGVwcy5mb3JFYWNoKGUgPT4ge1xuICAgICAgICAgICAgZS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmVfJyk7XG4gICAgICAgICAgICBlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RyYW5zaXRpb25lbmQnLCB0cmFuc2l0aW9uUGhhc2VUd28pO1xuICAgICAgICAgICAgZS5hcmlhSGlkZGVuID0gJ3RydWUnO1xuICAgICAgICAgICAgZS5zZXRBdHRyaWJ1dGUoJ2hpZGRlbicsICcnKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpc0VsZW0uY2xhc3NMaXN0LmFkZCgnYWN0aXZlXycpO1xuICAgICAgICB0aGlzRWxlbS5hcmlhSGlkZGVuID0gJ2ZhbHNlJztcbiAgICAgICAgdGhpc0VsZW0ucmVtb3ZlQXR0cmlidXRlKCdoaWRkZW4nKTtcblxuICAgICAgICBiY2RVbml2ZXJzYWwubmVzdEFuaW1hdGlvbkZyYW1lcygyLCAoKT0+e1xuICAgICAgICAgICAgdGhpc0VsZW0uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChvdGhlclN0ZXBzLmxlbmd0aCA9PT0gMCkgdHJhbnNpdGlvblBoYXNlVHdvKCk7XG4gICAgZWxzZSB7XG4gICAgICAgIG90aGVyU3RlcHMuZm9yRWFjaChlID0+IHtcbiAgICAgICAgICAgIGUuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7XG4gICAgICAgICAgICBlLmFkZEV2ZW50TGlzdGVuZXIoJ3RyYW5zaXRpb25lbmQnLCB0cmFuc2l0aW9uUGhhc2VUd28sIHtvbmNlOiB0cnVlfSk7XG4gICAgICAgIH0pO1xuICAgICAgICBzZXRUaW1lb3V0KHRyYW5zaXRpb25QaGFzZVR3bywgMjAwKTtcbiAgICB9XG5cbiAgICBmaXJzdFNldEVkaXRvciA9IGZhbHNlO1xuICAgIHdpbmRvdy5GT01PREJ1aWxkZXIuc3RvcmFnZS5wcmVmZXJlbmNlcyEuc3RlcHNCdWlsZGVyID0gdHlwZTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNob3dPcGVuQW5vdGhlckZvbGRlckRpYWxvZygpIHtcbiAgICBjb25zdCBkaWFsb2cgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnb3BlbmluZy1vdGhlci1wcm9qZWN0LW1vZGFsJykhLnVwZ3JhZGVzIS5nZXRFeHRlbmRzKGJjZFVuaXZlcnNhbC5CQ0RNb2RhbERpYWxvZylbMF0hO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRpYWxvZy5zaG93KCk7XG4gICAgaWYgKHJlc3VsdCAhPT0gJ2NvbmZpcm0nKSB7XG4gICAgICAgIGNvbnNvbGUuZGVidWcoYFVzZXIgY2FuY2VsbGVkIG9wZW5pbmcgYW5vdGhlciBmb2xkZXIgd2l0aCByZXNwb25zZSBcIiR7cmVzdWx0fVwiYCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmRlYnVnKGBVc2VyIGNvbmZpcm1lZCBvcGVuaW5nIGFub3RoZXIgZm9sZGVyIHdpdGggcmVzcG9uc2UgXCIke3Jlc3VsdH1cImApO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG59XG5cbmxldCB0YWJMaXN0OiBIVE1MRGl2RWxlbWVudHxudWxsID0gbnVsbDtcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBvcGVuRm9sZGVyKHRlc3QgPSBmYWxzZSkge1xuICAgIGlmIChsb2FkaW5nRm9tb2Quc3RhdGUpIHJldHVybjtcblxuXG4gICAgaWYgKCAod2luZG93LkZPTU9EQnVpbGRlci5kaXJlY3RvcnkgfHwgd2luZG93LkZPTU9EQnVpbGRlci50cmFja2VkRm9tb2QpICYmICFhd2FpdCBzaG93T3BlbkFub3RoZXJGb2xkZXJEaWFsb2coKSlcbiAgICAgICAgcmV0dXJuO1xuXG4gICAgaWYgKHRlc3QpIHtcbiAgICAgICAgbG9hZGluZ0ZvbW9kLnN0YXRlID0gdHJ1ZTtcblxuICAgICAgICB3aW5kb3cubG9hZFRlc3RGT01PRCgpO1xuXG4gICAgICAgIHBvc3RMb2FkKCk7XG5cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICgnc2hvd0RpcmVjdG9yeVBpY2tlcicgaW4gd2luZG93KSByZXR1cm4gYXdhaXQgb3BlbkZvbGRlcl9lbnRyeSgpO1xuXG4gICAgcG9zdExvYWQoZmFsc2UpO1xuXG4gICAgY29uc29sZS53YXJuKCdObyBkaXJlY3RvcnkgcGlja2VyIGF2YWlsYWJsZSBmb3IgeW91ciBzeXN0ZW0hJyk7XG4gICAgZm9tb2QuZ2V0Tm9TdXBwb3J0TW9kYWwoKT8uc2hvdygpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcG9zdExvYWQobG9hZGVkID0gdHJ1ZSkge1xuICAgIGF3YWl0IGJjZFVuaXZlcnNhbC53YWl0KDEwMCk7XG4gICAgbG9hZGluZ0ZvbW9kLnN0YXRlID0gZmFsc2U7XG5cbiAgICB0YWJMaXN0ID8/PSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFibGlzdCcpIGFzIEhUTUxEaXZFbGVtZW50O1xuXG4gICAgaWYgKGxvYWRlZCkge1xuICAgICAgICB0YWJMaXN0LnJlbW92ZUF0dHJpYnV0ZSgnZGlzYWJsZWQnKTtcbiAgICAgICAgdGFiTGlzdC5jbGFzc0xpc3QucmVtb3ZlKCd0YWJzLWxpc3QtY29udGFpbmVyLS1oaWRkZW4nKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0YWJMaXN0LnNldEF0dHJpYnV0ZSgnZGlzYWJsZWQnLCAnJyk7XG4gICAgICAgIHRhYkxpc3QuY2xhc3NMaXN0LmFkZCgndGFicy1saXN0LWNvbnRhaW5lci0taGlkZGVuJyk7XG4gICAgfVxufVxuXG5leHBvcnQgY29uc3QgbG9hZGluZ0ZvbW9kID0ge3N0YXRlOiBmYWxzZX07XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBvcGVuRm9sZGVyX2VudHJ5KCkge1xuICAgIGlmIChsb2FkaW5nRm9tb2Quc3RhdGUpIHJldHVybjtcbiAgICBsb2FkaW5nRm9tb2Quc3RhdGUgPSB0cnVlO1xuXG4gICAgY29uc29sZS5kZWJ1ZygnT3BlbmluZyBhIGZvbGRlciEnKTtcblxuICAgIGNvbnN0IHBpY2tlZCA9IGF3YWl0IGJjZEZTLmdldFVzZXJQaWNrZWRGb2xkZXIodHJ1ZSk7XG4gICAgaWYgKCFwaWNrZWQpIHJldHVybiBsb2FkaW5nRm9tb2Quc3RhdGUgPSBmYWxzZTtcblxuICAgIGNvbnNvbGUuZGVidWcoJ1BpY2tlZCBmb2xkZXI6JywgcGlja2VkKTtcbiAgICBjb25zb2xlLmRlYnVnKCdQaWNrZWQgZm9sZGVyIG5hbWU6JywgcGlja2VkPy5oYW5kbGUubmFtZSk7XG4gICAgY29uc29sZS5kZWJ1ZygnUGlja2VkIGZvbGRlciBwZXJtcz8nLCBhd2FpdCBwaWNrZWQ/LmhhbmRsZS5xdWVyeVBlcm1pc3Npb24oe21vZGU6ICdyZWFkd3JpdGUnfSkpO1xuXG4gICAgd2luZG93LkZPTU9EQnVpbGRlci5kaXJlY3RvcnkgPSBwaWNrZWQ7XG5cbiAgICBjb25zdCBmb21vZERpciA9IGF3YWl0IHBpY2tlZC5jaGlsZERpcnNDWydmb21vZCddITtcbiAgICBjb25zdCBtb2R1bGVTdHJfID0gZm9tb2REaXIuY2hpbGRGaWxlc0NbJ01vZHVsZUNvbmZpZy54bWwnXSEudGhlbihmaWxlID0+IGZpbGUucmVhZEFzVGV4dCgpKTtcbiAgICBjb25zdCBpbmZvU3RyXyA9IGZvbW9kRGlyLmNoaWxkRmlsZXNDWydJbmZvLnhtbCddIS50aGVuKGZpbGUgPT4gZmlsZS5yZWFkQXNUZXh0KCkpO1xuXG4gICAgY29uc3QgW21vZHVsZVN0ciwgaW5mb1N0cl0gPSBhd2FpdCBQcm9taXNlLmFsbChbbW9kdWxlU3RyXywgaW5mb1N0cl9dKTtcblxuICAgIHhtbC50cmFuc2xhdGVXaG9sZShtb2R1bGVTdHIsIGluZm9TdHIsIHRydWUpO1xuXG4gICAgcG9zdExvYWQoKTtcbn1cblxuLyoqIEFuIGFsdGVybmF0aXZlIHRvIGBzYXZlYCB0aGF0IHdpbGwgc2V0IHRoZSBET00gZWxlbWVudHMgaW5zdGVhZC4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZXRPdXRwdXRFbGVtZW50cygpIHtcbiAgICBpZiAoc2F2aW5nKSByZXR1cm47XG4gICAgc2F2aW5nID0gdHJ1ZTtcblxuICAgIGlmICghd2luZG93LkZPTU9EQnVpbGRlci50cmFja2VkRm9tb2QpIHRocm93IG5ldyBFcnJvcignTm8gRk9NT0QgaXMgY3VycmVudGx5IGxvYWRlZC4nKTtcblxuICAgIGNvbnN0IGluZm9Eb2MgPSB3aW5kb3cuRk9NT0RCdWlsZGVyLnRyYWNrZWRGb21vZCEuaW5mb0RvYztcbiAgICBjb25zdCBtb2R1bGVEb2MgPSB3aW5kb3cuRk9NT0RCdWlsZGVyLnRyYWNrZWRGb21vZCEubW9kdWxlRG9jO1xuXG4gICAgbGV0IGluZm9TdHJpbmcgPSB3aW5kb3cuRk9NT0RCdWlsZGVyLnRyYWNrZWRGb21vZCEub2JqLmFzSW5mb1hNTChpbmZvRG9jKS5vdXRlckhUTUwgfHwgJzwhLS0gRVJST1IgLSBTZXJpYWxpemVkIGRvY3VtZW50IHdhcyBlbXB0eSEgLS0+JztcbiAgICBpZiAod2luZG93LkZPTU9EQnVpbGRlci5zdG9yYWdlLnNldHRpbmdzLmZvcm1hdFhNTCkgaW5mb1N0cmluZyA9IHZrQmVhdXRpZnkueG1sKGluZm9TdHJpbmcpO1xuICAgIGVsc2UgaW5mb1N0cmluZyA9IHZrQmVhdXRpZnkueG1sbWluKGluZm9TdHJpbmcsIHRydWUpO1xuXG4gICAgY29uc29sZS5sb2coe2luZm9TdHJpbmd9KTtcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW5mby14bWwnKSEudGV4dENvbnRlbnQgPSBpbmZvU3RyaW5nO1xuXG4gICAgbGV0IG1vZHVsZVN0cmluZyA9IHdpbmRvdy5GT01PREJ1aWxkZXIudHJhY2tlZEZvbW9kIS5vYmouYXNNb2R1bGVYTUwobW9kdWxlRG9jKS5vdXRlckhUTUwgfHwgJzwhLS0gRVJST1IgLSBTZXJpYWxpemVkIGRvY3VtZW50IHdhcyBlbXB0eSEgLS0+JztcbiAgICBpZiAod2luZG93LkZPTU9EQnVpbGRlci5zdG9yYWdlLnNldHRpbmdzLmZvcm1hdFhNTCkgbW9kdWxlU3RyaW5nID0gdmtCZWF1dGlmeS54bWwobW9kdWxlU3RyaW5nKTtcbiAgICBlbHNlIG1vZHVsZVN0cmluZyA9IHZrQmVhdXRpZnkueG1sbWluKG1vZHVsZVN0cmluZywgdHJ1ZSk7XG5cbiAgICBjb25zb2xlLmxvZyh7bW9kdWxlU3RyaW5nfSk7XG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21vZHVsZS14bWwnKSEudGV4dENvbnRlbnQgPSBtb2R1bGVTdHJpbmc7XG5cbiAgICAvLyBPbmNlIHdlJ3JlIGRvbmUgc2F2aW5nLCBub3RlIGl0IGFzIHN1Y2guXG4gICAgc2F2aW5nID0gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIGZvcm1hdFhtbChzdHJpbmc6IHN0cmluZykge1xuICAgIGlmICh3aW5kb3cuRk9NT0RCdWlsZGVyLnN0b3JhZ2Uuc2V0dGluZ3MuZm9ybWF0WE1MKSByZXR1cm4gdmtCZWF1dGlmeS54bWwoc3RyaW5nKTtcbiAgICBlbHNlIHJldHVybiB2a0JlYXV0aWZ5LnhtbG1pbihzdHJpbmcsIHRydWUpO1xufVxuXG5sZXQgc2F2aW5nID0gZmFsc2U7XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2F2ZSgpIHtcbiAgICBpZiAoc2F2aW5nKSByZXR1cm47XG4gICAgc2F2aW5nID0gdHJ1ZTtcblxuICAgIGlmICghd2luZG93LkZPTU9EQnVpbGRlci50cmFja2VkRm9tb2QpIHRocm93IG5ldyBFcnJvcignTm8gRk9NT0QgaXMgY3VycmVudGx5IGxvYWRlZC4nKTtcblxuICAgIGlmICghd2luZG93LkZPTU9EQnVpbGRlci5kaXJlY3RvcnkpIHtcbiAgICAgICAgYXdhaXQgc2V0T3V0cHV0RWxlbWVudHMoKTtcbiAgICAgICAgcmV0dXJuIHNhdmluZyA9IGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IGZvbW9kRm9sZGVyID0gKGF3YWl0IHdpbmRvdy5GT01PREJ1aWxkZXIuZGlyZWN0b3J5LmNoaWxkRGlyc0NbJ2ZvbW9kJ10pITtcblxuICAgIGNvbnN0IGZvbW9kSW5mb18gPSBmb21vZEZvbGRlci5jaGlsZEZpbGVzQ1snSW5mby54bWwnXSE7XG4gICAgY29uc3QgZm9tb2RNb2R1bGVfID0gZm9tb2RGb2xkZXIuY2hpbGRGaWxlc0NbJ01vZHVsZUNvbmZpZy54bWwnXSE7XG4gICAgY29uc3QgW2ZvbW9kSW5mbywgZm9tb2RNb2R1bGVdID0gYXdhaXQgUHJvbWlzZS5hbGwoW2ZvbW9kSW5mb18sIGZvbW9kTW9kdWxlX10pO1xuXG5cbiAgICBjb25zdCBpbmZvRG9jID0gd2luZG93LkZPTU9EQnVpbGRlci50cmFja2VkRm9tb2QhLmluZm9Eb2M7XG4gICAgY29uc3QgaW5mb1N0cmluZyA9IGZvcm1hdFhtbCh3aW5kb3cuRk9NT0RCdWlsZGVyLnRyYWNrZWRGb21vZCEub2JqLmFzSW5mb1hNTChpbmZvRG9jKS5vdXRlckhUTUwgfHwgJzwhLS0gRVJST1IgLSBTZXJpYWxpemVkIGRvY3VtZW50IHdhcyBlbXB0eSEgLS0+Jyk7XG4gICAgY29uc3Qgd3JpdGVJbmZvUHJvbWlzZSA9IGZvbW9kSW5mby53cml0ZShpbmZvU3RyaW5nKTtcbiAgICBjb25zb2xlLmxvZyh7aW5mb1N0cmluZ30pO1xuXG4gICAgY29uc3QgbW9kdWxlRG9jID0gd2luZG93LkZPTU9EQnVpbGRlci50cmFja2VkRm9tb2QhLm1vZHVsZURvYztcbiAgICBjb25zdCBtb2R1bGVTdHJpbmcgPSBmb3JtYXRYbWwod2luZG93LkZPTU9EQnVpbGRlci50cmFja2VkRm9tb2QhLm9iai5hc01vZHVsZVhNTChtb2R1bGVEb2MpLm91dGVySFRNTCB8fCAnPCEtLSBFUlJPUiAtIFNlcmlhbGl6ZWQgZG9jdW1lbnQgd2FzIGVtcHR5ISAtLT4nKTtcbiAgICBjb25zdCB3cml0ZU1vZHVsZVByb21pc2UgPSBmb21vZE1vZHVsZS53cml0ZShtb2R1bGVTdHJpbmcpO1xuICAgIGNvbnNvbGUubG9nKHttb2R1bGVTdHJpbmd9KTtcblxuXG5cbiAgICAvLyBPbmNlIHdlJ3JlIGRvbmUgc2F2aW5nLCBub3RlIGl0IGFzIHN1Y2guXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoW3dyaXRlSW5mb1Byb21pc2UsIHdyaXRlTW9kdWxlUHJvbWlzZV0pO1xuICAgIGhhc1Vuc2F2ZWRDaGFuZ2VzID0gZmFsc2U7XG4gICAgc2F2aW5nID0gZmFsc2U7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjbGVhblNhdmUoKXtcbiAgICBpZiAoc2F2aW5nKSByZXR1cm47XG4gICAgaWYgKCF3aW5kb3cuRk9NT0RCdWlsZGVyLnRyYWNrZWRGb21vZCkgdGhyb3cgbmV3IEVycm9yKCdObyBGT01PRCBpcyBjdXJyZW50bHkgbG9hZGVkLicpO1xuXG4gICAgd2luZG93LkZPTU9EQnVpbGRlci50cmFja2VkRm9tb2QhLmluZm9Eb2MgPSB3aW5kb3cuZG9tUGFyc2VyLnBhcnNlRnJvbVN0cmluZygnPGZvbW9kLz4nLCAndGV4dC94bWwnKTtcbiAgICB3aW5kb3cuRk9NT0RCdWlsZGVyLnRyYWNrZWRGb21vZCEubW9kdWxlRG9jID0gd2luZG93LmRvbVBhcnNlci5wYXJzZUZyb21TdHJpbmcoJzxjb25maWcvPicsICd0ZXh0L3htbCcpO1xuXG4gICAgcmV0dXJuIGF3YWl0IHNhdmUoKTtcbn1cblxubGV0IHNhdmVUaW1lb3V0Om51bGx8bnVtYmVyID0gbnVsbDtcbmxldCBoYXNVbnNhdmVkQ2hhbmdlcyA9IGZhbHNlO1xuZXhwb3J0IGZ1bmN0aW9uIGF1dG9TYXZlKCkge1xuICAgIGlmIChzYXZpbmcgfHwgbG9hZGluZ0ZvbW9kLnN0YXRlKSByZXR1cm47XG4gICAgaWYgKCF3aW5kb3cuRk9NT0RCdWlsZGVyLnRyYWNrZWRGb21vZCkgcmV0dXJuO1xuXG4gICAgaGFzVW5zYXZlZENoYW5nZXMgPSB0cnVlO1xuXG4gICAgaWYgKCF3aW5kb3cuRk9NT0RCdWlsZGVyLnN0b3JhZ2Uuc2V0dGluZ3MuYXV0b1NhdmVBZnRlckNoYW5nZSkgcmV0dXJuO1xuXG4gICAgaWYgKHNhdmVUaW1lb3V0ICE9PSBudWxsKSBjbGVhclRpbWVvdXQoc2F2ZVRpbWVvdXQpO1xuICAgIHNhdmVUaW1lb3V0ID0gYmNkVW5pdmVyc2FsLmFmdGVyRGVsYXkoNTAwLCAoKSA9PiB7XG4gICAgICAgIHNhdmVUaW1lb3V0ID0gbnVsbDtcbiAgICAgICAgaWYgKHdpbmRvdy5GT01PREJ1aWxkZXIuc3RvcmFnZS5zZXR0aW5ncy5hdXRvQ2xlYW5TYXZlKSBjbGVhblNhdmUoKTtcbiAgICAgICAgZWxzZSBzYXZlKCk7XG4gICAgfSk7XG59XG5cbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdiZWZvcmV1bmxvYWQnLCAoZXZlbnQpID0+IHtcbiAgICBpZiAoIWhhc1Vuc2F2ZWRDaGFuZ2VzKSByZXR1cm47XG5cbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGV2ZW50LnJldHVyblZhbHVlID0gJyc7XG4gICAgcmV0dXJuICcnO1xufSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBpbml0KCkge1xuICAgIGJjZFVuaXZlcnNhbC5yZWdpc3RlckJDRENvbXBvbmVudHMoQkNERHJvcGRvd25Tb3J0aW5nT3JkZXIsIEJDRERyb3Bkb3duT3B0aW9uU3RhdGUsIEJDRERyb3Bkb3duR3JvdXBUeXBlKTtcbiAgICBzZXRTdGVwRWRpdG9yVHlwZSh3aW5kb3cuRk9NT0RCdWlsZGVyLnN0b3JhZ2UucHJlZmVyZW5jZXMuc3RlcHNCdWlsZGVyKTtcblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICB3aW5kb3cuZm9tb2RVbmRvTWFuYWdlciA9IGZvbW9kVW5kb01hbmFnZXI7XG5cbiAgICB3aW5kb3cucmVnaXN0ZXJGb3JFdmVudHMoZG9jdW1lbnQsIHtcbiAgICAgICAgc2F2ZTogKCkgPT4gc2F2ZSgpLFxuICAgIH0pO1xuXG4gICAgY29uc29sZS5sb2coJ0ZPTU9EIEJ1aWxkZXIgVUkgaW5pdGlhbGl6ZWQuJyk7XG59XG4iXX0=