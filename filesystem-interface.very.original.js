export class InvalidNameError extends Error {
    constructor(message, cause) {
        super(`${message} (Offending name: "${cause}")`);
        this.name = 'InvalidNameError';
        this.cause = cause;
    }
}
export function getFolderFromFolder(create, target, prop) {
    if (!prop)
        throw new InvalidNameError('Folder name cannot be empty.', prop);
    const name = prop.trim().toLowerCase();
    if (!(name in target)) {
        const dir = (async () => {
            try {
                const handle = this.handle.getDirectoryHandle(prop, { create }).catch(e => {
                    if (!(e instanceof Error))
                        throw e;
                    if (e instanceof DOMException && e.name === 'NotFoundError') {
                        delete this.childDirsC[name];
                        return null;
                    }
                    else if (e instanceof InvalidNameError || e.message === 'Name is not allowed.' || e.message === 'Cannot get a file with an empty name.')
                        throw new InvalidNameError('Folder name is not allowed.', prop);
                    else
                        throw e;
                });
                if (handle === null)
                    return null;
                return new BellFolder(await this.handle.getDirectoryHandle(prop, { create }));
            }
            catch (e) {
                if (e instanceof DOMException && e.name === 'NotFoundError') {
                    delete this.childDirsC[name];
                    return null;
                }
                else
                    throw e;
            }
        })();
        this.childDirs[name] = dir;
        this.childDirsC[name] = dir;
    }
    return target[name];
}
export function getFileFromFolder(create, target, prop) {
    if (!prop)
        throw new Error('Cannot get a file with an empty name.', { cause: 'invalid-argument' });
    const name = prop.trim().toLowerCase();
    if (!(name in target) || target[name] === null) {
        const handle = this.handle.getFileHandle(prop, { create }).catch(e => {
            if (e instanceof DOMException && e.name === 'NotFoundError') {
                delete this.childFilesC[name];
                return null;
            }
            else if (e instanceof TypeError && e.message === 'Name is not allowed.')
                throw new InvalidNameError('File name is not allowed.', prop);
            else
                throw e;
        }).then(handle => handle ? new BellFile(handle) : null);
        this.childFiles[name] = handle;
        this.childFilesC[name] = handle;
    }
    return target[name];
}
export class BellFolder {
    handle;
    childDirs = new Proxy({}, {
        get: getFolderFromFolder.bind(this, false),
    });
    childDirsC = new Proxy({}, {
        get: getFolderFromFolder.bind(this, true),
    });
    childFiles = new Proxy({}, {
        get: getFileFromFolder.bind(this, false),
    });
    childFilesC = new Proxy({}, {
        get: getFileFromFolder.bind(this, true),
    });
    async getFile(name, create) {
        const parts = name.split('/');
        parts.forEach((part, index, arr) => {
            const parts2 = part.split('\\');
            arr.splice(index, 1, ...parts2);
        });
        const debug_fullPath = [...parts];
        const fileName = parts.pop();
        if (!fileName)
            throw new InvalidNameError('File name is empty.', name);
        const pathItems = [];
        let currentFolder = this;
        for (let i = 0; i < parts.length; i++) {
            const debug_targetPath = parts.slice(0, i + 1).join('/');
            try {
                currentFolder = await currentFolder[create ? 'childDirsC' : 'childDirs'][parts[i]];
                if (!currentFolder)
                    return null;
                pathItems.push(currentFolder);
            }
            catch (e) {
                if (!(e instanceof Error))
                    throw e;
                if (e instanceof InvalidNameError || e.message === 'Name is not allowed.' || e.message === 'Cannot get a file with an empty name.') {
                    console.info(`Could not get folder "${debug_targetPath}" for file due to invalid name:`, debug_fullPath, e);
                    throw e;
                }
                else if (e instanceof DOMException && e.name === 'NotFoundError')
                    console.info(`Could not find folder "${debug_targetPath}" for file:`, debug_fullPath, e);
                else
                    console.error(`Error getting folder "${debug_targetPath}" for file:`, debug_fullPath, e);
                return null;
            }
        }
        try {
            const lastItem = await currentFolder[create ? 'childFilesC' : 'childFiles'][fileName];
            if (!lastItem)
                return null;
            pathItems.push(lastItem);
            return pathItems;
        }
        catch (e) {
            if (!(e instanceof Error))
                throw e;
            if (e instanceof InvalidNameError || e.message === 'Name is not allowed.' || e.message === 'Cannot get a file with an empty name.') {
                console.info(`Could not get file "${fileName}" due to invalid name:`, debug_fullPath, e);
                throw e;
            }
            else if (e instanceof DOMException && e.name === 'NotFoundError')
                console.info(`Could not find file "${debug_fullPath}"`, e);
            else
                console.error(`Error getting file "${debug_fullPath}"`, e);
            return null;
        }
    }
    async openFilePicker(options) {
        try {
            const files = await (options?.save ? window.showSaveFilePicker(options) : window.showOpenFilePicker(options));
            if (!files)
                return [];
            if (files instanceof FileSystemFileHandle)
                return [new BellFile(files)];
            return files.map(file => new BellFile(file));
        }
        catch (e) {
            console.debug('Error opening file picker:', e);
            return [];
        }
    }
    async resolveChildPath(child, returnNull = false) {
        try {
            if (child.file instanceof File)
                throw new Error('Cannot resolve child path of a File object');
            const resolved = await this.handle.resolve(child.file);
            if (resolved === null)
                throw new Error('Could not resolve child path');
            return resolved;
        }
        catch (e) {
            if (returnNull)
                return null;
            throw e;
        }
    }
    constructor(handle) {
        this.handle = handle;
    }
}
export class BellFile {
    file;
    constructor(handle) {
        this.file = handle;
    }
    static async read(file, key) {
        key ??= 'readAsText';
        const reader = new FileReader();
        if (!(key in reader && typeof reader[key] === 'function'))
            throw new Error(`Invalid key "${key}"`);
        reader[key](file);
        return await new Promise((resolve, reject) => {
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.onabort = reject;
        });
    }
    async readAsText() {
        return await BellFile.read(this.file instanceof File ? this.file : await this.file.getFile(), 'readAsText');
    }
    async readAsArrayBuffer() {
        return await BellFile.read(this.file instanceof File ? this.file : await this.file.getFile(), 'readAsArrayBuffer');
    }
    async readAsDataURL() {
        return await BellFile.read(this.file instanceof File ? this.file : await this.file.getFile(), 'readAsDataURL');
    }
    async readAsBinaryString() {
        return await BellFile.read(this.file instanceof File ? this.file : await this.file.getFile(), 'readAsBinaryString');
    }
    static async write(file, ...params) {
        const writer = await file.createWritable();
        await writer.write(...params);
        await writer.close();
    }
    async write(...params) {
        if (this.file instanceof File)
            throw new Error('Cannot write to a File object');
        return await BellFile.write(this.file, ...params);
    }
}
export class writeableFolder extends BellFolder {
    constructor(handle, SUPER_IMPORTANT__IS_THIS_FOLDER_WRITEABLE) {
        if (SUPER_IMPORTANT__IS_THIS_FOLDER_WRITEABLE !== true)
            throw new Error("This folder is not writeable!");
        super(handle);
    }
}
export async function getUserPickedFolder(write) {
    const permStr = `read${write ? 'write' : ''}`;
    let thisHandle;
    try {
        thisHandle = await window.showDirectoryPicker({ mode: permStr });
    }
    catch (e) {
        if (!(e instanceof DOMException && e.name === 'AbortError'))
            throw e;
        console.info('User cancelled the folder picker');
        return null;
    }
    let permState = await thisHandle.queryPermission({ mode: permStr });
    if (permState !== 'granted')
        permState = await thisHandle.requestPermission({ mode: permStr });
    if (permState === 'granted')
        return write ?
            new writeableFolder(thisHandle, true) :
            new BellFolder(thisHandle);
    else {
        console.info(`Permission denied: current state is ${permState}`);
        return null;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZXN5c3RlbS1pbnRlcmZhY2UuanMiLCJzb3VyY2VSb290IjoiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0JlbGxDdWJlRGV2L3NpdGUtdGVzdGluZy9kZXBsb3ltZW50LyIsInNvdXJjZXMiOlsiZmlsZXN5c3RlbS1pbnRlcmZhY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsTUFBTSxPQUFPLGdCQUFpQixTQUFRLEtBQUs7SUFDdkMsWUFBWSxPQUFlLEVBQUUsS0FBYTtRQUN0QyxLQUFLLENBQUMsR0FBRyxPQUFPLHNCQUFzQixLQUFLLElBQUksQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxJQUFJLEdBQUcsa0JBQWtCLENBQUM7UUFDL0IsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDdkIsQ0FBQztDQUNKO0FBSUQsTUFBTSxVQUFVLG1CQUFtQixDQUErQyxNQUFlLEVBQUUsTUFBd0YsRUFBRSxJQUFZO0lBQzdMLElBQUksQ0FBQyxJQUFJO1FBQUUsTUFBTSxJQUFJLGdCQUFnQixDQUFDLDhCQUE4QixFQUFFLElBQUksQ0FBQyxDQUFDO0lBR3BGLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUd2QyxJQUFJLENBQUMsQ0FBQyxJQUFJLElBQUksTUFBTSxDQUFDLEVBQUM7UUFFbEIsTUFBTSxHQUFHLEdBQUcsQ0FBQyxLQUFLLElBQUcsRUFBRTtZQUVuQixJQUFJO2dCQUVBLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLEVBQUMsTUFBTSxFQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7b0JBQ3BFLElBQUksQ0FBQyxDQUFDLENBQUMsWUFBWSxLQUFLLENBQUM7d0JBQUUsTUFBTSxDQUFDLENBQUM7b0JBRW5DLElBQUksQ0FBQyxZQUFZLFlBQVksSUFBSSxDQUFDLENBQUMs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UCxJQUFJLGVBQWUsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUN2QyxJQUFJLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUUxRDtRQUNELE9BQU8sQ0FBQyxJQUFJLENBQUMsdUNBQXVDLFNBQVMsRUFBRSxDQUFDLENBQUM7UUFDakUsT0FBTyxJQUFJLENBQUM7S0FDZjtBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgaW50ZXJmYWNlIGZvbGRlckVudHJ5IHtcbiAgICBoYW5kbGU6IEZpbGVTeXN0ZW1IYW5kbGU7XG59XG5cbmV4cG9ydCBjbGFzcyBJbnZhbGlkTmFtZUVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICAgIGNvbnN0cnVjdG9yKG1lc3NhZ2U6IHN0cmluZywgY2F1c2U6IHN0cmluZykge1xuICAgICAgICBzdXBlcihgJHttZXNzYWdlfSAoT2ZmZW5kaW5nIG5hbWU6IFwiJHtjYXVzZX1cIilgKTtcbiAgICAgICAgdGhpcy5uYW1lID0gJ0ludmFsaWROYW1lRXJyb3InO1xuICAgICAgICB0aGlzLmNhdXNlID0gY2F1c2U7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Rm9sZGVyRnJvbUZvbGRlcjxUQ3JlYXRlIGV4dGVuZHMgZmFsc2U+KHRoaXM6IEJlbGxGb2xkZXIsIGNyZWF0ZTogVENyZWF0ZSwgdGFyZ2V0OiBSZWNvcmQ8c3RyaW5nLCBQcm9taXNlPEJlbGxGb2xkZXIgfCBudWxsPj4sIHByb3A6IHN0cmluZyk6IFByb21pc2U8QmVsbEZvbGRlciB8IG51bGw+XG5leHBvcnQgZnVuY3Rpb24gZ2V0Rm9sZGVyRnJvbUZvbGRlcjxUQ3JlYXRlIGV4dGVuZHMgdHJ1ZSA+KHRoaXM6IEJlbGxGb2xkZXIsIGNyZWF0ZTogVENyZWF0ZSwgdGFyZ2V0OiBSZWNvcmQ8c3RyaW5nLCBQcm9taXNlPEJlbGxGb2xkZXI+PiwgcHJvcDogc3RyaW5nKTogUHJvbWlzZTxCZWxsRm9sZGVyPlxuZXhwb3J0IGZ1bmN0aW9uIGdldEZvbGRlckZyb21Gb2xkZXI8VENyZWF0ZSBleHRlbmRzIHRydWV8ZmFsc2U+KHRoaXM6IEJlbGxGb2xkZXIsIGNyZWF0ZTogVENyZWF0ZSwgdGFyZ2V0OiBSZWNvcmQ8c3RyaW5nLCBQcm9taXNlPEJlbGxGb2xkZXI+PiB8IFJlY29yZDxzdHJpbmcsIFByb21pc2U8QmVsbEZvbGRlciB8IG51bGw+PiwgcHJvcDogc3RyaW5nKTogUHJvbWlzZTxCZWxsRm9sZGVyPiB8IFByb21pc2U8QmVsbEZvbGRlcnxudWxsPiB7XG4gICAgICAgICAgICBpZiAoIXByb3ApIHRocm93IG5ldyBJbnZhbGlkTmFtZUVycm9yKCdGb2xkZXIgbmFtZSBjYW5ub3QgYmUgZW1wdHkuJywgcHJvcCk7XG5cbiAgICAvLyBNYWtlIHRoZSBuYW1lIGNhc2UtaW5zZW5zaXRpdmVcbiAgICBjb25zdCBuYW1lID0gcHJvcC50cmltKCkudG9Mb3dlckNhc2UoKTtcblxuICAgIC8vIEZldGNoL2NyZWF0ZSBmb2xkZXIgaWYgaXQgZG9lc24ndCBhbHJlYWR5IGV4aXN0XG4gICAgaWYgKCEobmFtZSBpbiB0YXJnZXQpKXtcblxuICAgICAgICBjb25zdCBkaXIgPSAoYXN5bmMoKSA9PiB7XG5cbiAgICAgICAgICAgIHRyeSB7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBoYW5kbGUgPSB0aGlzLmhhbmRsZS5nZXREaXJlY3RvcnlIYW5kbGUocHJvcCwge2NyZWF0ZX0pLmNhdGNoKGUgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIShlIGluc3RhbmNlb2YgRXJyb3IpKSB0aHJvdyBlO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgRE9NRXhjZXB0aW9uICYmIGUubmFtZSA9PT0gJ05vdEZvdW5kRXJyb3InKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jaGlsZERpcnNDW25hbWVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoZSBpbnN0YW5jZW9mIEludmFsaWROYW1lRXJyb3IgfHwgZS5tZXNzYWdlID09PSAnTmFtZSBpcyBub3QgYWxsb3dlZC4nIHx8IGUubWVzc2FnZSA9PT0gJ0Nhbm5vdCBnZXQgYSBmaWxlIHdpdGggYW4gZW1wdHkgbmFtZS4nKVxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWROYW1lRXJyb3IoJ0ZvbGRlciBuYW1lIGlzIG5vdCBhbGxvd2VkLicsIHByb3ApO1xuICAgICAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICAgICAgICAgIH0pO1xuXG5cbiAgICAgICAgICAgICAgICBpZiAoaGFuZGxlID09PSBudWxsKSByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEJlbGxGb2xkZXIoXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlLmdldERpcmVjdG9yeUhhbmRsZShwcm9wLCB7Y3JlYXRlfSlcbiAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG5cbiAgICAgICAgICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIERPTUV4Y2VwdGlvbiAmJiBlLm5hbWUgPT09ICdOb3RGb3VuZEVycm9yJykge1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jaGlsZERpcnNDW25hbWVdO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB0aHJvdyBlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KSgpO1xuXG4gICAgICAgIHRoaXMuY2hpbGREaXJzW25hbWVdID0gZGlyO1xuICAgICAgICB0aGlzLmNoaWxkRGlyc0NbbmFtZV0gPSBkaXIgYXMgUHJvbWlzZTxCZWxsRm9sZGVyPjtcbiAgICB9XG5cbiAgICAvLyBSZXR1cm4gdGhlIG5ld2x5LWFzc3VyZWQgZm9sZGVyIChvciBudWxsLCBidXQgd2UgZG9uJ3QgdGVsbCBUeXBlU2NyaXB0IHRoYXQgb3IgaXQgd291bGQgZnJlYWsgb3V0KVxuICAgIHJldHVybiB0YXJnZXRbbmFtZV0hO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RmlsZUZyb21Gb2xkZXIodGhpczogQmVsbEZvbGRlciwgY3JlYXRlOiBmYWxzZSwgdGFyZ2V0OiBSZWNvcmQ8c3RyaW5nLCBQcm9taXNlPEJlbGxGaWxlIHwgbnVsbD4+LCBwcm9wOiBzdHJpbmcpIDogUHJvbWlzZTxCZWxsRmlsZSB8IG51bGw+XG5leHBvcnQgZnVuY3Rpb24gZ2V0RmlsZUZyb21Gb2xkZXIodGhpczogQmVsbEZvbGRlciwgY3JlYXRlOiB0cnVlLCB0YXJnZXQ6IFJlY29yZDxzdHJpbmcsIFByb21pc2U8QmVsbEZpbGUgICAgICAgPj4sIHByb3A6IHN0cmluZykgOiBQcm9taXNlPEJlbGxGaWxlPlxuZXhwb3J0IGZ1bmN0aW9uIGdldEZpbGVGcm9tRm9sZGVyPFRDcmVhdGUgZXh0ZW5kcyB0cnVlfGZhbHNlPiAodGhpczogQmVsbEZvbGRlciwgY3JlYXRlOiBUQ3JlYXRlLCB0YXJnZXQ6IFJlY29yZDxzdHJpbmcsIFByb21pc2U8QmVsbEZpbGU+IHwgUHJvbWlzZTxCZWxsRmlsZSB8IG51bGw+PiwgcHJvcDogc3RyaW5nKSA6IFByb21pc2U8QmVsbEZpbGU+IHwgIFByb21pc2U8QmVsbEZpbGUgfCBudWxsPiB7XG4gICAgaWYgKCFwcm9wKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBnZXQgYSBmaWxlIHdpdGggYW4gZW1wdHkgbmFtZS4nLCB7Y2F1c2U6ICdpbnZhbGlkLWFyZ3VtZW50J30pO1xuXG4gICAgLy8gTWFrZSB0aGUgbmFtZSBjYXNlLWluc2Vuc2l0aXZlXG4gICAgY29uc3QgbmFtZSA9IHByb3AudHJpbSgpLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAvLyBGZXRjaC9jcmVhdGUgZmlsZSBpZiBpdCBkb2Vzbid0IGFscmVhZHkgZXhpc3RcbiAgICAgICAgaWYgKCEobmFtZSBpbiB0YXJnZXQpIHx8IHRhcmdldFtuYW1lXSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgY29uc3QgaGFuZGxlID0gdGhpcy5oYW5kbGUuZ2V0RmlsZUhhbmRsZShwcm9wLCB7Y3JlYXRlfSkuY2F0Y2goZSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICBlIGluc3RhbmNlb2YgRE9NRXhjZXB0aW9uICYmIGUubmFtZSA9PT0gJ05vdEZvdW5kRXJyb3InKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoaWxkRmlsZXNDW25hbWVdO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gTmFtZSBpcyBub3QgYWxsb3dlZFxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKGUgaW5zdGFuY2VvZiBUeXBlRXJyb3IgJiYgZS5tZXNzYWdlID09PSAnTmFtZSBpcyBub3QgYWxsb3dlZC4nKVxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZE5hbWVFcnJvcignRmlsZSBuYW1lIGlzIG5vdCBhbGxvd2VkLicsIHByb3ApO1xuICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgICAgIH0pLnRoZW4oaGFuZGxlID0+IGhhbmRsZSA/IG5ldyBCZWxsRmlsZShoYW5kbGUpIDogbnVsbCk7XG5cbiAgICAgICAgICAgIHRoaXMuY2hpbGRGaWxlc1tuYW1lXSA9IGhhbmRsZTtcbiAgICAgICAgICAgIHRoaXMuY2hpbGRGaWxlc0NbbmFtZV0gPSBoYW5kbGUgYXMgUHJvbWlzZTxCZWxsRmlsZT47XG4gICAgICAgIH1cblxuICAgIC8vIFJldHVybiB0aGUgbmV3bHktYXNzdXJlZCBmaWxlIChvciBudWxsLCBidXQgd2UgZG9uJ3QgdGVsbCBUeXBlU2NyaXB0IHRoYXQgb3IgaXQgd291bGQgZnJlYWsgb3V0KVxuICAgIHJldHVybiB0YXJnZXRbbmFtZV0hO1xufVxuXG5cbmV4cG9ydCBjbGFzcyBCZWxsRm9sZGVyIHtcbiAgICByZWFkb25seSBoYW5kbGU6IEZpbGVTeXN0ZW1EaXJlY3RvcnlIYW5kbGU7XG5cblxuICAgIC8qKiBXcmFwcGVyIFByb3h5IHByb3BlcnR5IHRoYXQgZmV0Y2hlcyBmb2xkZXJzIGFzIHRob3VnaCB0aGV5IHdlcmUgbmVzdGVkIHByb21pc2VzLlxuXG4gICAgICAgIC0tLVxuICAgICAgICBUaGlzIHByb3BlcnR5IHdpbGwgKipOT1QqKiBjcmVhdGUgZm9sZGVycy4gSWYgeW91IHdvdWxkIGxpa2UgdG8gZmV0Y2ggKm9yKiBjcmVhdGUgYSBmb2xkZXIsIHVzZSBgY2hpbGREaXJzQ2BcbiAgICAgICAgQHRocm93cyBgSW52YWxpZE5hbWVFcnJvcmAgd2hlbiB0aGUgcHJvdmlkZWQgbmFtZSBpcyBpbnZhbGlkLlxuICAgICovXG4gICAgcmVhZG9ubHkgY2hpbGREaXJzID0gbmV3IFByb3h5KHt9LCB7XG4gICAgICAgIGdldDogZ2V0Rm9sZGVyRnJvbUZvbGRlci5iaW5kPHRoaXMsIGZhbHNlLCBbdGFyZ2V0OiBSZWNvcmQ8c3RyaW5nLCBQcm9taXNlPEJlbGxGb2xkZXIgfCBudWxsPj4sIHByb3A6IHN0cmluZ10sIFByb21pc2U8QmVsbEZvbGRlciB8IG51bGw+Pih0aGlzLCBmYWxzZSksXG4gICAgfSk7XG5cbiAgICAvKiogV3JhcHBlciBQcm94eSBwcm9wZXJ0eSB0aGF0IGZldGNoZXMgZm9sZGVycyBhcyB0aG91Z2ggdGhleSB3ZXJlIG5lc3RlZCBwcm9taXNlcy5cblxuICAgICAgICAtLS1cbiAgICAgICAgVGhpcyBwcm9wZXJ0eSAqKldJTEwqKiBjcmVhdGUgZm9sZGVycyBpZiB0aGV5IGRvIG5vdCBhbHJlYWR5IGV4aXN0LiBJZiB5b3Ugd291bGQgbGlrZSB0byByZWNlaXZlIGBudWxsYCBpbnN0ZWFkIG9mIGNyZWF0aW5nIGEgZm9sZGVyLCB1c2UgYGNoaWxkRGlyc2BcbiAgICAgICAgQHRocm93cyBgSW52YWxpZE5hbWVFcnJvcmAgd2hlbiB0aGUgcHJvdmlkZWQgbmFtZSBpcyBpbnZhbGlkLlxuICAgICovXG4gICAgcmVhZG9ubHkgY2hpbGREaXJzQyA9IG5ldyBQcm94eSh7fSwge1xuICAgICAgICBnZXQ6IGdldEZvbGRlckZyb21Gb2xkZXIuYmluZCh0aGlzLCB0cnVlKSxcbiAgICB9KTtcblxuICAgIC8qKiBXcmFwcGVyIFByb3h5IHByb3BlcnR5IHRoYXQgZmV0Y2hlcyBmaWxlcyBhcyB0aG91Z2ggdGhleSB3ZXJlIG5lc3RlZCBwcm9taXNlcy5cblxuICAgICAgICAtLS1cbiAgICAgICAgVGhpcyBwcm9wZXJ0eSB3aWxsICoqTk9UKiogY3JlYXRlIGZpbGVzLiBJZiB5b3Ugd291bGQgbGlrZSB0byBmZXRjaCAqb3IqIGNyZWF0ZSBhIGZpbGUsIHVzZSBgY2hpbGRGaWxlc0NgXG4gICAgICAgIEB0aHJvd3MgYEludmFsaWROYW1lRXJyb3JgIHdoZW4gdGhlIHByb3ZpZGVkIG5hbWUgaXMgaW52YWxpZC5cbiAgICAqL1xuICAgIHJlYWRvbmx5IGNoaWxkRmlsZXMgPSBuZXcgUHJveHkoe30sIHtcbiAgICAgICAgZ2V0OiBnZXRGaWxlRnJvbUZvbGRlci5iaW5kPHRoaXMsIGZhbHNlLCBbdGFyZ2V0OiBSZWNvcmQ8c3RyaW5nLCBQcm9taXNlPEJlbGxGaWxlIHwgbnVsbD4+LCBwcm9wOiBzdHJpbmddLCBQcm9taXNlPEJlbGxGaWxlIHwgbnVsbD4+KHRoaXMsIGZhbHNlKSxcbiAgICB9KTtcblxuICAgIC8qKiBXcmFwcGVyIFByb3h5IHByb3BlcnR5IHRoYXQgZmV0Y2hlcyBmaWxlcyBhcyB0aG91Z2ggdGhleSB3ZXJlIG5lc3RlZCBwcm9taXNlcy5cblxuICAgICAgICAtLS1cbiAgICAgICAgVGhpcyBwcm9wZXJ0eSAqKldJTEwqKiBjcmVhdGUgZmlsZXMgaWYgdGhleSBkbyBub3QgYWxyZWFkeSBleGlzdC4gSWYgeW91IHdvdWxkIGxpa2UgdG8gcmVjZWl2ZSBgbnVsbGAgaW5zdGVhZCBvZiBjcmVhdGluZyBhIGZpbGUsIHVzZSBgY2hpbGRGaWxlc2BcbiAgICAgICAgQHRocm93cyBgSW52YWxpZE5hbWVFcnJvcmAgd2hlbiB0aGUgcHJvdmlkZWQgbmFtZSBpcyBpbnZhbGlkLlxuICAgICovXG4gICAgcmVhZG9ubHkgY2hpbGRGaWxlc0MgPSBuZXcgUHJveHkoe30sIHtcbiAgICAgICAgZ2V0OiBnZXRGaWxlRnJvbUZvbGRlci5iaW5kKHRoaXMsIHRydWUpLFxuICAgIH0pO1xuXG4gICAgYXN5bmMgZ2V0RmlsZShuYW1lOiBzdHJpbmcpOiBQcm9taXNlPFsuLi5CZWxsRm9sZGVyW10sIEJlbGxGaWxlXXxudWxsPjtcbiAgICBhc3luYyBnZXRGaWxlKG5hbWU6IHN0cmluZywgY3JlYXRlOiB0cnVlKTogUHJvbWlzZTxbLi4uQmVsbEZvbGRlcltdLCBCZWxsRmlsZV0+XG4gICAgYXN5bmMgZ2V0RmlsZShuYW1lOiBzdHJpbmcsIGNyZWF0ZT86IGJvb2xlYW4pOiBQcm9taXNlPFsuLi5CZWxsRm9sZGVyW10sIEJlbGxGaWxlXXxudWxsPiB7XG4gICAgICAgIC8vIFNwbGl0IGJ5IGZvcndhcmQgc2xhc2hlc1xuICAgICAgICBjb25zdCBwYXJ0cyA9IG5hbWUuc3BsaXQoJy8nKTtcblxuICAgICAgICAvLyBTcGxpdCBieSBiYWNrc2xhc2hlc1xuICAgICAgICBwYXJ0cy5mb3JFYWNoKChwYXJ0LCBpbmRleCwgYXJyKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwYXJ0czIgPSBwYXJ0LnNwbGl0KCdcXFxcJyk7XG4gICAgICAgICAgICBhcnIuc3BsaWNlKGluZGV4LCAxLCAuLi5wYXJ0czIpO1xuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBkZWJ1Z19mdWxsUGF0aCA9IFsuLi5wYXJ0c107XG4gICAgICAgIC8vY29uc29sZS5sb2coJ0dldHRpbmcgZmlsZTonLCBkZWJ1Z19mdWxsUGF0aCk7XG5cbiAgICAgICAgY29uc3QgZmlsZU5hbWUgPSBwYXJ0cy5wb3AoKSE7XG5cbiAgICAgICAgaWYgKCFmaWxlTmFtZSkgdGhyb3cgbmV3IEludmFsaWROYW1lRXJyb3IoJ0ZpbGUgbmFtZSBpcyBlbXB0eS4nLCBuYW1lKTtcblxuICAgICAgICBjb25zdCBwYXRoSXRlbXM6IChCZWxsRm9sZGVyfEJlbGxGaWxlKVtdID0gW107XG5cbiAgICAgICAgLy8gR2V0IHRoZSBmaWxlXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdGhpcy1hbGlhc1xuICAgICAgICBsZXQgY3VycmVudEZvbGRlcjogQmVsbEZvbGRlcnxudWxsID0gdGhpcztcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgY29uc3QgZGVidWdfdGFyZ2V0UGF0aCA9IHBhcnRzLnNsaWNlKDAsIGkgKyAxKS5qb2luKCcvJyk7XG5cbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY3VycmVudEZvbGRlciA9IGF3YWl0IGN1cnJlbnRGb2xkZXJbY3JlYXRlID8gJ2NoaWxkRGlyc0MnIDogJ2NoaWxkRGlycyddW3BhcnRzW2ldIV0hO1xuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ0VudGVyZWQgZm9sZGVyOiAnLCBkZWJ1Z190YXJnZXRQYXRoLCBjdXJyZW50Rm9sZGVyKTtcbiAgICAgICAgICAgICAgICBpZiAoIWN1cnJlbnRGb2xkZXIpIHJldHVybiBudWxsO1xuXG4gICAgICAgICAgICAgICAgcGF0aEl0ZW1zLnB1c2goY3VycmVudEZvbGRlcik7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCEoZSBpbnN0YW5jZW9mIEVycm9yKSkgdGhyb3cgZTtcblxuICAgICAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgSW52YWxpZE5hbWVFcnJvciB8fCBlLm1lc3NhZ2UgPT09ICdOYW1lIGlzIG5vdCBhbGxvd2VkLicgfHwgZS5tZXNzYWdlID09PSAnQ2Fubm90IGdldCBhIGZpbGUgd2l0aCBhbiBlbXB0eSBuYW1lLicpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKGBDb3VsZCBub3QgZ2V0IGZvbGRlciBcIiR7ZGVidWdfdGFyZ2V0UGF0aH1cIiBmb3IgZmlsZSBkdWUgdG8gaW52YWxpZCBuYW1lOmAsIGRlYnVnX2Z1bGxQYXRoLCBlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGUgaW5zdGFuY2VvZiBET01FeGNlcHRpb24gJiYgZS5uYW1lID09PSAnTm90Rm91bmRFcnJvcicpXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhgQ291bGQgbm90IGZpbmQgZm9sZGVyIFwiJHtkZWJ1Z190YXJnZXRQYXRofVwiIGZvciBmaWxlOmAsIGRlYnVnX2Z1bGxQYXRoLCBlKTtcbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIGdldHRpbmcgZm9sZGVyIFwiJHtkZWJ1Z190YXJnZXRQYXRofVwiIGZvciBmaWxlOmAsIGRlYnVnX2Z1bGxQYXRoLCBlKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGxhc3RJdGVtID0gYXdhaXQgY3VycmVudEZvbGRlcltjcmVhdGUgPyAnY2hpbGRGaWxlc0MnIDogJ2NoaWxkRmlsZXMnXVtmaWxlTmFtZV07XG4gICAgICAgICAgICBpZiAoIWxhc3RJdGVtKSByZXR1cm4gbnVsbDtcblxuICAgICAgICAgICAgcGF0aEl0ZW1zLnB1c2gobGFzdEl0ZW0pO1xuICAgICAgICAgICAgcmV0dXJuIHBhdGhJdGVtcyBhcyBbLi4uQmVsbEZvbGRlcltdLCBCZWxsRmlsZV07XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGlmICghKGUgaW5zdGFuY2VvZiBFcnJvcikpIHRocm93IGU7XG5cbiAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2YgSW52YWxpZE5hbWVFcnJvciB8fCBlLm1lc3NhZ2UgPT09ICdOYW1lIGlzIG5vdCBhbGxvd2VkLicgfHwgZS5tZXNzYWdlID09PSAnQ2Fubm90IGdldCBhIGZpbGUgd2l0aCBhbiBlbXB0eSBuYW1lLicpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmluZm8oYENvdWxkIG5vdCBnZXQgZmlsZSBcIiR7ZmlsZU5hbWV9XCIgZHVlIHRvIGludmFsaWQgbmFtZTpgLCBkZWJ1Z19mdWxsUGF0aCwgZSk7XG4gICAgICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZSBpbnN0YW5jZW9mIERPTUV4Y2VwdGlvbiAmJiBlLm5hbWUgPT09ICdOb3RGb3VuZEVycm9yJylcbiAgICAgICAgICAgICAgICBjb25zb2xlLmluZm8oYENvdWxkIG5vdCBmaW5kIGZpbGUgXCIke2RlYnVnX2Z1bGxQYXRofVwiYCwgZSk7XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgZ2V0dGluZyBmaWxlIFwiJHtkZWJ1Z19mdWxsUGF0aH1cImAsIGUpO1xuXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIG9wZW5GaWxlUGlja2VyKG9wdGlvbnM/OiBPcGVuRmlsZVBpY2tlck9wdGlvbnMgJiB7c2F2ZT86IGJvb2xlYW59KTogUHJvbWlzZTxCZWxsRmlsZVtdPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBmaWxlcyA9IGF3YWl0ICggIG9wdGlvbnM/LnNhdmUgPyB3aW5kb3cuc2hvd1NhdmVGaWxlUGlja2VyKG9wdGlvbnMpIDogd2luZG93LnNob3dPcGVuRmlsZVBpY2tlcihvcHRpb25zKSAgKTtcbiAgICAgICAgICAgIGlmICghZmlsZXMpIHJldHVybiBbXTtcblxuICAgICAgICAgICAgaWYgKGZpbGVzIGluc3RhbmNlb2YgRmlsZVN5c3RlbUZpbGVIYW5kbGUpIHJldHVybiBbbmV3IEJlbGxGaWxlKGZpbGVzKV07XG4gICAgICAgICAgICByZXR1cm4gZmlsZXMubWFwKGZpbGUgPT4gbmV3IEJlbGxGaWxlKGZpbGUpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnRXJyb3Igb3BlbmluZyBmaWxlIHBpY2tlcjonLCBlKTtcbiAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgYXN5bmMgcmVzb2x2ZUNoaWxkUGF0aChjaGlsZDogQmVsbEZpbGUsIHJldHVybk51bGw/OiBmYWxzZSk6IFByb21pc2U8c3RyaW5nW10+XG4gICAgYXN5bmMgcmVzb2x2ZUNoaWxkUGF0aChjaGlsZDogQmVsbEZpbGUsIHJldHVybk51bGw6IHRydWUpOiBQcm9taXNlPHN0cmluZ1tdIHwgbnVsbD5cbiAgICBhc3luYyByZXNvbHZlQ2hpbGRQYXRoKGNoaWxkOiBCZWxsRmlsZSwgcmV0dXJuTnVsbCA9IGZhbHNlKTogUHJvbWlzZTxzdHJpbmdbXSB8IG51bGw+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmIChjaGlsZC5maWxlIGluc3RhbmNlb2YgRmlsZSkgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgcmVzb2x2ZSBjaGlsZCBwYXRoIG9mIGEgRmlsZSBvYmplY3QnKTtcblxuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSBhd2FpdCB0aGlzLmhhbmRsZS5yZXNvbHZlKGNoaWxkLmZpbGUpO1xuICAgICAgICAgICAgaWYgKHJlc29sdmVkID09PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCByZXNvbHZlIGNoaWxkIHBhdGgnKTtcblxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBpZiAocmV0dXJuTnVsbCkgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoaGFuZGxlOiBGaWxlU3lzdGVtRGlyZWN0b3J5SGFuZGxlKSB7XG4gICAgICAgIHRoaXMuaGFuZGxlID0gaGFuZGxlO1xuICAgIH1cbn1cblxudHlwZSBGaWxlUmVhZGVyUmVhZEtleXMgPSBSZWNvcmQ8a2V5b2YgRmlsZVJlYWRlciAmIGByZWFkQXMke3N0cmluZ31gLCB1bmtub3duPiAmIHtcbiAgICByZWFkQXNBcnJheUJ1ZmZlcjogQXJyYXlCdWZmZXI7XG4gICAgcmVhZEFzQmluYXJ5U3RyaW5nOiBzdHJpbmc7XG4gICAgcmVhZEFzRGF0YVVSTDogc3RyaW5nO1xuICAgIHJlYWRBc1RleHQ6IHN0cmluZztcbn07XG5cbmV4cG9ydCBjbGFzcyBCZWxsRmlsZSB7XG4gICAgcmVhZG9ubHkgZmlsZTogRmlsZVN5c3RlbUZpbGVIYW5kbGV8RmlsZTtcblxuICAgIGNvbnN0cnVjdG9yKGhhbmRsZTogRmlsZVN5c3RlbUZpbGVIYW5kbGV8RmlsZSkge1xuICAgICAgICB0aGlzLmZpbGUgPSBoYW5kbGU7XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIHJlYWQ8VFJldHVybiBleHRlbmRzIEZpbGVSZWFkZXJSZWFkS2V5c1tURnVuY3RdLCBURnVuY3QgZXh0ZW5kcyAoa2V5b2YgRmlsZVJlYWRlciAmIGByZWFkQXMke3N0cmluZ31gKSA9ICdyZWFkQXNUZXh0Jz4oZmlsZTogRmlsZSwga2V5PzogVEZ1bmN0KTogUHJvbWlzZTxUUmV0dXJuPiB7XG4gICAgICAgIGtleSA/Pz0gJ3JlYWRBc1RleHQnIGFzIFRGdW5jdDtcblxuICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgICAgICBpZiAoICAhKGtleSBpbiByZWFkZXIgJiYgdHlwZW9mIHJlYWRlcltrZXldID09PSAnZnVuY3Rpb24nKSAgKSB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQga2V5IFwiJHtrZXl9XCJgKTtcblxuICAgICAgICByZWFkZXJba2V5XShmaWxlKTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8VFJldHVybj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgcmVhZGVyLm9ubG9hZCA9ICgpID0+IHJlc29sdmUocmVhZGVyLnJlc3VsdCBhcyBUUmV0dXJuKTtcbiAgICAgICAgICAgIHJlYWRlci5vbmVycm9yID0gcmVqZWN0O1xuICAgICAgICAgICAgcmVhZGVyLm9uYWJvcnQgPSByZWplY3Q7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIHJlYWRBc1RleHQoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IEJlbGxGaWxlLnJlYWQodGhpcy5maWxlIGluc3RhbmNlb2YgRmlsZSA/IHRoaXMuZmlsZSA6IGF3YWl0IHRoaXMuZmlsZS5nZXRGaWxlKCksICdyZWFkQXNUZXh0Jyk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVhZEFzQXJyYXlCdWZmZXIoKTogUHJvbWlzZTxBcnJheUJ1ZmZlcj4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgQmVsbEZpbGUucmVhZCh0aGlzLmZpbGUgaW5zdGFuY2VvZiBGaWxlID8gdGhpcy5maWxlIDogYXdhaXQgdGhpcy5maWxlLmdldEZpbGUoKSwgJ3JlYWRBc0FycmF5QnVmZmVyJyk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVhZEFzRGF0YVVSTCgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgQmVsbEZpbGUucmVhZCh0aGlzLmZpbGUgaW5zdGFuY2VvZiBGaWxlID8gdGhpcy5maWxlIDogYXdhaXQgdGhpcy5maWxlLmdldEZpbGUoKSwgJ3JlYWRBc0RhdGFVUkwnKTtcbiAgICB9XG5cbiAgICBhc3luYyByZWFkQXNCaW5hcnlTdHJpbmcoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IEJlbGxGaWxlLnJlYWQodGhpcy5maWxlIGluc3RhbmNlb2YgRmlsZSA/IHRoaXMuZmlsZSA6IGF3YWl0IHRoaXMuZmlsZS5nZXRGaWxlKCksICdyZWFkQXNCaW5hcnlTdHJpbmcnKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgd3JpdGUoZmlsZTogRmlsZVN5c3RlbUZpbGVIYW5kbGUsIC4uLnBhcmFtczpQYXJhbWV0ZXJzPEZpbGVTeXN0ZW1Xcml0YWJsZUZpbGVTdHJlYW1bJ3dyaXRlJ10+KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHdyaXRlciA9IGF3YWl0IGZpbGUuY3JlYXRlV3JpdGFibGUoKTtcbiAgICAgICAgYXdhaXQgd3JpdGVyLndyaXRlKC4uLnBhcmFtcyk7XG4gICAgICAgIGF3YWl0IHdyaXRlci5jbG9zZSgpO1xuICAgIH1cblxuICAgIGFzeW5jIHdyaXRlKC4uLnBhcmFtczpQYXJhbWV0ZXJzPEZpbGVTeXN0ZW1Xcml0YWJsZUZpbGVTdHJlYW1bJ3dyaXRlJ10+KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICh0aGlzLmZpbGUgaW5zdGFuY2VvZiBGaWxlKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCB3cml0ZSB0byBhIEZpbGUgb2JqZWN0Jyk7XG4gICAgICAgIHJldHVybiBhd2FpdCBCZWxsRmlsZS53cml0ZSh0aGlzLmZpbGUsIC4uLnBhcmFtcyk7XG4gICAgfVxufVxuZXhwb3J0IGNsYXNzIHdyaXRlYWJsZUZvbGRlciBleHRlbmRzIEJlbGxGb2xkZXIge1xuICAgIC8qKiBBIGZvbGRlciB0aGF0IHlvdSBoYXZlIFZFUklGSUVEIGlzIHdyaXRlYWJsZVxuICAgICAqIEBwYXJhbSBoYW5kbGUgVGhlIGhhbmRsZSB0byB0aGUgZm9sZGVyXG4gICAgICogQHBhcmFtIFNVUEVSX0lNUE9SVEFOVF9fSVNfVEhJU19GT0xERVJfV1JJVEVBQkxFIFRoaXMgaXMgYSBib29sZWFuIHRoYXQgeW91IGhhdmUgdmVyaWZpZWQgaXMgdHJ1ZS4gSWYgaXQgaXMgZmFsc2UsIHlvdSB3aWxsIGdldCBhbiBlcnJvci4gSWYgeW91IHNldCBpdCB0byB0cnVlLCBNQUtFIFNVUkUgVEhBVCBZT1UgQVJFIFZFUklGWUlORyBUSEFUIFRIRSBGT0xERVIgSVMgV1JJVEVBQkxFLiBJZiB5b3UgZG9uJ3QsIHlvdSdsbCBnZXQgbW9yZSBwcmltaXRpdmUgZXJyb3JzLlxuICAgICovXG4gICAgY29uc3RydWN0b3IoaGFuZGxlOiBGaWxlU3lzdGVtRGlyZWN0b3J5SGFuZGxlLCBTVVBFUl9JTVBPUlRBTlRfX0lTX1RISVNfRk9MREVSX1dSSVRFQUJMRTogdHJ1ZSkge1xuICAgICAgICBpZiAoU1VQRVJfSU1QT1JUQU5UX19JU19USElTX0ZPTERFUl9XUklURUFCTEUgIT09IHRydWUpIHRocm93IG5ldyBFcnJvcihcIlRoaXMgZm9sZGVyIGlzIG5vdCB3cml0ZWFibGUhXCIpO1xuICAgICAgICBzdXBlcihoYW5kbGUpO1xuICAgIH1cbn1cblxuLyoqIFJldHVybnMgYSBmb2xkZXIgcGlja2VkIGJ5IHRoZSB1c2VyXG4gICAgQHRocm93cyBpZiB0aGUgdXNlciBjYW5jZWxzIHRoZSBkaWFsb2cgb3IgaWYgcGVybWlzc2lvbiBpcyBkZW5pZWRcbiovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0VXNlclBpY2tlZEZvbGRlcih3cml0ZTogYm9vbGVhbik6IFByb21pc2U8QmVsbEZvbGRlcnxudWxsPlxuXG4vKiogUmV0dXJucyBhIGZvbGRlciBwaWNrZWQgYnkgdGhlIHVzZXJcbiAgICBAdGhyb3dzIGlmIHRoZSB1c2VyIGNhbmNlbHMgdGhlIGRpYWxvZyBvciBpZiBwZXJtaXNzaW9uIGlzIGRlbmllZFxuKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRVc2VyUGlja2VkRm9sZGVyKHdyaXRlOiB0cnVlKTogUHJvbWlzZTx3cml0ZWFibGVGb2xkZXJ8bnVsbD5cblxuLyoqIFJldHVybnMgYSBmb2xkZXIgcGlja2VkIGJ5IHRoZSB1c2VyXG4gICAgQHRocm93cyBpZiB0aGUgdXNlciBjYW5jZWxzIHRoZSBkaWFsb2cgb3IgaWYgcGVybWlzc2lvbiBpcyBkZW5pZWRcbiovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0VXNlclBpY2tlZEZvbGRlcih3cml0ZT86IGJvb2xlYW4pOiBQcm9taXNlPEJlbGxGb2xkZXJ8bnVsbD4ge1xuICAgIC8vIENvbnN0cnVjdCBhIHN0cmluZyB0byByZXByZXNlbnQgdGhlIHBlcm1pc3Npb25zIHdlIG5lZWRcbiAgICBjb25zdCBwZXJtU3RyOiAncmVhZCd8J3JlYWR3cml0ZScgPSBgcmVhZCR7d3JpdGUgPyAnd3JpdGUnIDogJyd9YDtcblxuICAgIC8vIEdldCBhIGRpcmVjdG9yeVxuICAgIGxldCB0aGlzSGFuZGxlOiBGaWxlU3lzdGVtRGlyZWN0b3J5SGFuZGxlO1xuICAgIHRyeSB7XG4gICAgICAgIHRoaXNIYW5kbGUgPSBhd2FpdCB3aW5kb3cuc2hvd0RpcmVjdG9yeVBpY2tlcih7bW9kZTogcGVybVN0cn0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKCEoZSBpbnN0YW5jZW9mIERPTUV4Y2VwdGlvbiAmJiBlLm5hbWUgPT09ICdBYm9ydEVycm9yJykpIHRocm93IGU7XG5cbiAgICAgICAgY29uc29sZS5pbmZvKCdVc2VyIGNhbmNlbGxlZCB0aGUgZm9sZGVyIHBpY2tlcicpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBGZXRjaCBjdXJyZW50IHBlcm1pc3Npb24gc3RhdGVcbiAgICBsZXQgcGVybVN0YXRlID0gYXdhaXQgdGhpc0hhbmRsZS5xdWVyeVBlcm1pc3Npb24oe21vZGU6IHBlcm1TdHJ9KTtcblxuICAgIC8vIFJlcXVlc3QgcGVybWlzc2lvbiBpZiB3ZSBkb24ndCBhbHJlYWR5IGhhdmUgaXRcbiAgICBpZiAocGVybVN0YXRlICE9PSAnZ3JhbnRlZCcpIHBlcm1TdGF0ZSA9IGF3YWl0IHRoaXNIYW5kbGUucmVxdWVzdFBlcm1pc3Npb24oe21vZGU6IHBlcm1TdHJ9KTtcblxuICAgIC8vUmV0dXJuIHRoZSBoYW5kbGUgT05MWSBpZiB3ZSBoYXZlIHRoZSByZXF1aXJlZCBwZXJtaXNzaW9uc1xuICAgIGlmIChwZXJtU3RhdGUgPT09ICdncmFudGVkJykgcmV0dXJuIHdyaXRlID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgd3JpdGVhYmxlRm9sZGVyKHRoaXNIYW5kbGUsIHRydWUpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgQmVsbEZvbGRlcih0aGlzSGFuZGxlKTtcblxuICAgIGVsc2Uge1xuICAgICAgICBjb25zb2xlLmluZm8oYFBlcm1pc3Npb24gZGVuaWVkOiBjdXJyZW50IHN0YXRlIGlzICR7cGVybVN0YXRlfWApO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59XG4iXX0=